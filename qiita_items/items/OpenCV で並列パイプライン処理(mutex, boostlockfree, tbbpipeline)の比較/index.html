<p>この記事はおそらく <a href="OpenCV%20Advent%20Calendar%202017">https://qiita.com/advent-calendar/2017/opencv</a> の 12/12 の記事です。</p>

<h1>
<span id="opencv-で並列パイプライン処理mutex-boostlockfree-tbbpipelineの比較" class="fragment"></span><a href="#opencv-%E3%81%A7%E4%B8%A6%E5%88%97%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E5%87%A6%E7%90%86mutex-boostlockfree-tbbpipeline%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>OpenCV で並列パイプライン処理(mutex, boost::lockfree, tbb::pipeline)の比較</h1>

<h2>
<span id="動機" class="fragment"></span><a href="#%E5%8B%95%E6%A9%9F"><i class="fa fa-link"></i></a>動機</h2>

<ul>
<li>VideoCapture -&gt; 物体追跡とか重い処理 -&gt; VideoWriter な処理がしたい</li>
<li>パイプライン並列にできそう</li>
</ul>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main_naive</span><span class="p">(</span><span class="n">string</span> <span class="n">INPUT_VIDEO_PATH</span><span class="p">,</span> <span class="n">string</span> <span class="n">OUTPUT_VIDEO_PATH</span><span class="p">){</span>
  <span class="k">auto</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="p">{</span> <span class="n">INPUT_VIDEO_PATH</span> <span class="p">};</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">reader</span><span class="p">.</span><span class="n">isOpened</span><span class="p">()){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"C++: reader cannot opened</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_WIDTH</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_HEIGHT</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">fps</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FPS</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="p">{</span> <span class="s">"appsrc ! videoconvert ! x264enc ! mp4mux ! filesink location="</span> <span class="o">+</span> <span class="n">OUTPUT_VIDEO_PATH</span> <span class="o">+</span> <span class="s">"  "</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">{</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="p">},</span> <span class="nb">true</span><span class="p">};</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">src</span><span class="p">;</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">mid1</span><span class="p">,</span> <span class="n">mid2</span><span class="p">;</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">dst</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">src</span><span class="p">)){</span>
    <span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mid1</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2GRAY</span><span class="p">);</span>
    <span class="n">cv</span><span class="o">::</span><span class="n">threshold</span><span class="p">(</span><span class="n">mid1</span><span class="p">,</span> <span class="n">mid2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">THRESH_BINARY</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span> <span class="c1">// なんか重い処理</span>
    <span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">mid2</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">COLOR_GRAY2BGR</span><span class="p">);</span>
    <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="パイプライン並列を作る" class="fragment"></span><a href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E4%B8%A6%E5%88%97%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>パイプライン並列を作る</h2>

<h3>
<span id="mutex-と-queue-を使う" class="fragment"></span><a href="#mutex-%E3%81%A8-queue-%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>mutex と queue を使う</h3>

<ul>
<li>古来からの技法</li>
<li>
<code>lock_guard</code> で Scoped Locking Pattern を使った</li>
</ul>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main_mutex</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">){</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="p">;</span>
  <span class="n">mutex</span> <span class="n">src_que_mutex</span><span class="p">;</span>
  <span class="n">queue</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span> <span class="n">src_que</span><span class="p">;</span>
  <span class="n">mutex</span> <span class="n">dst_que_mutex</span><span class="p">;</span>
  <span class="n">queue</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span> <span class="n">dst_que</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">source_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="k">auto</span> <span class="n">src</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
      <span class="k">if</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)){</span>
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">src_que_mutex</span><span class="p">};</span>
        <span class="n">src_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">src_que_mutex</span><span class="p">};</span>
        <span class="n">src_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>

  <span class="k">auto</span> <span class="n">serial_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">src</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
      <span class="p">{</span> 
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">src_que_mutex</span><span class="p">};</span>
        <span class="k">if</span><span class="p">(</span><span class="n">src_que</span><span class="p">.</span><span class="n">empty</span><span class="p">()){</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">src_que</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
        <span class="n">src_que</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">){</span>
        <span class="k">auto</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
        <span class="n">heavy</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
        <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
        <span class="p">{</span>
          <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">dst_que_mutex</span><span class="p">};</span>
          <span class="n">dst_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">dst_que_mutex</span><span class="p">};</span>
        <span class="n">dst_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>
  <span class="k">auto</span> <span class="n">sink_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
      <span class="p">{</span> 
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">dst_que_mutex</span><span class="p">};</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dst_que</span><span class="p">.</span><span class="n">empty</span><span class="p">()){</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">dst_que</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
        <span class="n">dst_que</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">dst</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">){</span>
         <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">);</span>
         <span class="k">delete</span> <span class="n">dst</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>
  <span class="n">source_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="n">serial_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="n">sink_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="boostlockfreequeue-を使う" class="fragment"></span><a href="#boostlockfreequeue-%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>boost::lockfree::queue を使う</h3>

<ul>
<li>並列処理のキューといえばこれ</li>
<li>mutex を気にしなくてもよいのでかなり気が楽</li>
</ul>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main_lockfree</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">){</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">boost</span><span class="o">::</span><span class="n">lockfree</span><span class="o">::</span><span class="n">queue</span><span class="p">;</span>
  <span class="n">queue</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span> <span class="n">src_que</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="n">queue</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span> <span class="n">dst_que</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">source_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]{</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">src</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
      <span class="k">if</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)){</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">src_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">src</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">};</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">src_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">auto</span> <span class="n">serial_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">src</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">src_que</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">src</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">){</span>
        <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
        <span class="n">heavy</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
        <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">dst_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">dst</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">dst_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>
  <span class="k">auto</span> <span class="n">sink_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">dst_que</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dst</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">dst</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">){</span>
        <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">);</span>
        <span class="k">delete</span> <span class="n">dst</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>
  <span class="n">source_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="n">serial_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="n">sink_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h3>
<span id="intel-threading-building-blocks-を使う" class="fragment"></span><a href="#intel-threading-building-blocks-%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>Intel® Threading Building Blocks を使う</h3>

<ul>
<li>巨人の肩の上に立つ</li>
</ul>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Source</span><span class="o">:</span> <span class="k">public</span> <span class="n">tbb</span><span class="o">::</span><span class="n">filter</span> <span class="p">{</span>
<span class="nl">private:</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span> <span class="n">reader</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="n">Source</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">)</span><span class="o">:</span> <span class="n">filter</span><span class="p">(</span><span class="n">tbb</span><span class="o">::</span><span class="n">filter</span><span class="o">::</span><span class="n">mode</span><span class="o">::</span><span class="n">serial_in_order</span><span class="p">),</span> <span class="n">reader</span><span class="p">{</span><span class="n">reader</span><span class="p">}</span> <span class="p">{};</span>
  <span class="kt">void</span><span class="o">*</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">void</span><span class="o">*</span><span class="p">){</span>
    <span class="k">auto</span> <span class="n">src</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)){</span>
      <span class="k">return</span> <span class="n">src</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">SerialFilter</span><span class="o">:</span> <span class="k">public</span> <span class="n">tbb</span><span class="o">::</span><span class="n">filter</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">SerialFilter</span><span class="p">()</span><span class="o">:</span> <span class="n">filter</span><span class="p">(</span><span class="n">tbb</span><span class="o">::</span><span class="n">filter</span><span class="o">::</span><span class="n">mode</span><span class="o">::</span><span class="n">serial_in_order</span><span class="p">)</span> <span class="p">{};</span>
  <span class="kt">void</span><span class="o">*</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">){</span>
    <span class="k">auto</span> <span class="n">src</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
    <span class="n">heavy</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
    <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Sink</span><span class="o">:</span> <span class="k">public</span> <span class="n">tbb</span><span class="o">::</span><span class="n">filter</span> <span class="p">{</span>
<span class="nl">private:</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span> <span class="n">writer</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="n">Sink</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">)</span><span class="o">:</span> <span class="n">filter</span><span class="p">{</span><span class="n">tbb</span><span class="o">::</span><span class="n">filter</span><span class="o">::</span><span class="n">mode</span><span class="o">::</span><span class="n">serial_in_order</span><span class="p">},</span> <span class="n">writer</span><span class="p">{</span><span class="n">writer</span><span class="p">}</span> <span class="p">{};</span>
  <span class="kt">void</span><span class="o">*</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">){</span>
    <span class="k">auto</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
    <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">);</span>
    <span class="k">delete</span> <span class="n">dst</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main_tbb</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">){</span>
  <span class="n">tbb</span><span class="o">::</span><span class="n">task_scheduler_init</span> <span class="n">init</span><span class="p">;</span>
  <span class="n">tbb</span><span class="o">::</span><span class="n">pipeline</span> <span class="n">pipe</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">{</span><span class="n">reader</span><span class="p">};</span>
  <span class="k">auto</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">SerialFilter</span><span class="p">{};</span>
  <span class="k">auto</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">Sink</span><span class="p">{</span><span class="n">writer</span><span class="p">};</span>
  <span class="n">pipe</span><span class="p">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
  <span class="n">pipe</span><span class="p">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
  <span class="n">pipe</span><span class="p">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
  <span class="n">pipe</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h2>

<div class="code-frame" data-lang="console"><div class="highlight"><pre><span class="gp">root@70ce88779368:/data#</span><span class="w"> </span><span class="nb">time</span> ./a.out <span class="nt">--input</span> big_buck_bunny_720p_30mb.mp4 <span class="nt">--output</span> naive.mp4 <span class="nt">--mode</span> 0
<span class="go">

real    0m58.225s
user    1m29.259s
sys     0m8.369s
</span><span class="gp">root@70ce88779368:/data#</span><span class="w"> </span><span class="nb">time</span> ./a.out <span class="nt">--input</span> big_buck_bunny_720p_30mb.mp4 <span class="nt">--output</span> mutex.mp4 <span class="nt">--mode</span> 1
<span class="go">
real    0m47.476s
user    2m13.875s
sys     0m12.271s
</span><span class="gp">root@70ce88779368:/data#</span><span class="w"> </span><span class="nb">time</span> ./a.out <span class="nt">--input</span> big_buck_bunny_720p_30mb.mp4 <span class="nt">--output</span> lockfree.mp4 <span class="nt">--mode</span> 2
<span class="go">
real    0m49.268s
user    2m15.517s
sys     0m17.469s
</span><span class="gp">root@70ce88779368:/data#</span><span class="w"> </span><span class="nb">time</span> ./a.out <span class="nt">--input</span> big_buck_bunny_720p_30mb.mp4 <span class="nt">--output</span> tbb.mp4 <span class="nt">--mode</span> 3
<span class="go">
real    0m48.485s
user    1m33.380s
sys     0m31.989s
</span></pre></div></div>

<h2>
<span id="考察" class="fragment"></span><a href="#%E8%80%83%E5%AF%9F"><i class="fa fa-link"></i></a>考察</h2>

<ul>
<li>並列化した結果はほぼ同じ。</li>
<li>tbb 使った時の user 時間が非パイプライン並列版とあまり変わらないのが謎</li>
</ul>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<ul>
<li>画像処理が重い場合、パイプライン並列でスループットを向上させられる</li>
<li>自分でキューとパイプラインを作るよりも tbb 使ったほうが楽</li>
<li>処理時間の比較、多段パイプライン処理の比較、スレッド数の比較などは今後の課題とする</li>
</ul>

<h2>
<span id="reference" class="fragment"></span><a href="#reference"><i class="fa fa-link"></i></a>reference</h2>

<ul>
<li>オープンソース化された並列化テンプレートクラスライブラリ「Intel Threading Building Blocks」入門 -
<a href="https://mag.osdn.jp/09/08/21/1128207/6" class="autolink" rel="nofollow noopener" target="_blank">https://mag.osdn.jp/09/08/21/1128207/6</a>
</li>
<li>Intel® Threading Building Blocks - <a href="https://www.threadingbuildingblocks.org/docs/help/index.htm" class="autolink" rel="nofollow noopener" target="_blank">https://www.threadingbuildingblocks.org/docs/help/index.htm</a>
</li>
<li>Boost.Lockfree - <a href="http://www.boost.org/doc/libs/1_63_0/doc/html/lockfree.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.boost.org/doc/libs/1_63_0/doc/html/lockfree.html</a>
</li>
</ul>

<h2>
<span id="付録" class="fragment"></span><a href="#%E4%BB%98%E9%8C%B2"><i class="fa fa-link"></i></a>付録</h2>

<h3>
<span id="開発環境の-dockerfile" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%81%AE-dockerfile"><i class="fa fa-link"></i></a>開発環境の Dockerfile</h3>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre>docker build <span class="nt">-t</span> cpp-tbb-pipeline ./
wget http://www.sample-videos.com/video/mp4/720/big_buck_bunny_720p_30mb.mp4
docker run <span class="nt">-ti</span> <span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>:/data <span class="nt">--workdir</span> /data cpp-tbb-pipeline /bin/bash
</pre></div></div>

<div class="code-frame" data-lang="Dockerfile"><div class="highlight"><pre><span class="k">FROM</span><span class="s"> ubuntu:16.04</span>
<span class="k">ENV</span><span class="s"> DEBIAN_FRONTEND "noninteractive"</span>

<span class="k">RUN </span>apt-get update <span class="nt">-y</span>
<span class="k">RUN </span>apt-get <span class="nt">-y</span> <span class="se">\
</span>  <span class="nt">-o</span> Dpkg::Options::<span class="o">=</span><span class="s2">"--force-confdef"</span> <span class="se">\
</span>  <span class="nt">-o</span> Dpkg::Options::<span class="o">=</span><span class="s2">"--force-confold"</span> dist-upgrade

<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> <span class="se">\
</span>  dconf-tools <span class="se">\
</span>  apt-transport-https software-properties-common ppa-purge apt-utils <span class="se">\
</span>  ca-certificates git curl wget <span class="se">\
</span>  <span class="nb">tar </span>zip unzip zlib1g-dev bzip2 libbz2-dev <span class="se">\
</span>  openssl libssl-dev <span class="se">\
</span>  zsh vim screen tree htop <span class="se">\
</span>  <span class="nb">sudo</span>

<span class="c"># Install gcc and clang</span>
<span class="k">RUN </span>wget <span class="nt">-O</span> - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -
<span class="k">RUN </span>add-apt-repository <span class="s2">"deb http://apt.llvm.org/xenial/ llvm-toolchain-xenial-5.0 main"</span>
<span class="k">RUN </span>add-apt-repository ppa:ubuntu-toolchain-r/test
<span class="k">RUN </span>apt-get update <span class="nt">-y</span>
<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> <span class="se">\
</span>  build-essential binutils cmake autoconf automake autogen pkg-config libtool <span class="se">\
</span>  gcc-6 g++-6 gcc-7 g++-7 gdb <span class="se">\
</span>  clang-5.0 lldb-5.0 lld-5.0
<span class="k">RUN </span>update-alternatives <span class="nt">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-6 20
<span class="k">RUN </span>update-alternatives <span class="nt">--install</span> /usr/bin/g++ g++ /usr/bin/g++-6 20

<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> libboost-all-dev
<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> libtbb2 libtbb-dev
<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> libopenblas-dev liblapacke-dev
<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> libeigen3-dev
<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> ffmpeg libavcodec-dev libavformat-dev libswscale-dev
<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>  gstreamer1.0-tools <span class="se">\
</span>  gstreamer1.0-libav <span class="se">\
</span>  gstreamer1.0-libav-dbg <span class="se">\
</span>  gstreamer1.0-plugins-base <span class="se">\
</span>  gstreamer1.0-plugins-good <span class="se">\
</span>  gstreamer1.0-plugins-ugly <span class="se">\
</span>  gstreamer1.0-plugins-bad <span class="se">\
</span>  libgstreamer1.0-dev <span class="se">\
</span>  libgstreamer-plugins-base1.0-dev <span class="se">\
</span>  libgstreamer-plugins-good1.0-dev <span class="se">\
</span>  libgstreamer-plugins-bad1.0-dev
<span class="k">WORKDIR</span><span class="s"> /opt</span>
<span class="k">RUN </span>git clone <span class="nt">--recursive</span> <span class="nt">--depth</span> 1 https://github.com/opencv/opencv.git <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="nb">cd </span>opencv <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="nb">mkdir</span> <span class="nt">-p</span> build <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="nb">cd </span>build <span class="o">&amp;&amp;</span> <span class="se">\
</span>cmake <span class="se">\
</span>  <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span>RELEASE <span class="se">\
</span>  <span class="nt">-DBUILD_DOCS</span><span class="o">=</span>OFF <span class="se">\
</span>  <span class="nt">-DBUILD_EXAMPLES</span><span class="o">=</span>OFF <span class="se">\
</span>  <span class="nt">-DBUILD_TESTS</span><span class="o">=</span>OFF <span class="se">\
</span>  <span class="nt">-DBUILD_PERF_TESTS</span><span class="o">=</span>OFF <span class="se">\
</span>  <span class="nt">-DBUILD_WITH_DEBUG_INFO</span><span class="o">=</span>OFF <span class="se">\
</span>  <span class="nt">-DBUILD_SHARED_LIBS</span><span class="o">=</span>ON <span class="se">\
</span>  <span class="nt">-DWITH_OPENCL</span><span class="o">=</span>ON <span class="se">\
</span>  <span class="nt">-DWITH_OPENGL</span><span class="o">=</span>ON <span class="se">\
</span>  <span class="nt">-DENABLE_FAST_MATH</span><span class="o">=</span>ON <span class="se">\
</span>  <span class="nt">-DWITH_EIGEN</span><span class="o">=</span>ON <span class="se">\
</span>  <span class="nt">-DWITH_TBB</span><span class="o">=</span>ON <span class="se">\
</span>  <span class="nt">-DWITH_PTHREADS_PF</span><span class="o">=</span>ON <span class="se">\
</span>  <span class="nt">-DWITH_IPP</span><span class="o">=</span>ON <span class="se">\
</span>  <span class="nt">-DWITH_FFMPEG</span><span class="o">=</span>ON <span class="se">\
</span>  <span class="nt">-DWITH_GSTREAMER</span><span class="o">=</span>ON <span class="se">\
</span>  ../ <span class="o">&amp;&amp;</span> <span class="se">\
</span>make <span class="nt">-j</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>make <span class="nb">install</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>ldconfig

<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">-f</span>
<span class="k">RUN </span>apt-get update <span class="nt">-y</span>
<span class="k">RUN </span>apt-get upgrade <span class="nt">-y</span>
<span class="k">RUN </span>apt-get dist-upgrade <span class="nt">-y</span>

<span class="k">RUN </span>apt-get clean <span class="nt">-y</span>
<span class="k">RUN </span>apt-get autoremove <span class="nt">-y</span>
<span class="k">RUN </span>apt-get autoclean <span class="nt">-y</span>
<span class="k">RUN </span><span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span> /var/cache/apt/archives/<span class="k">*</span>
</pre></div></div>

<h2>
<span id="ソースコード" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>ソースコード</h2>

<div class="code-frame" data-lang="c++"><div class="highlight"><pre><span class="cp">#include &lt;iostream&gt;
#include &lt;cstdio&gt;
#include &lt;chrono&gt;
#include &lt;queue&gt;
#include &lt;mutex&gt;
#include &lt;thread&gt;
#include &lt;boost/program_options.hpp&gt;
#include &lt;boost/lockfree/queue.hpp&gt;
#include &lt;tbb/task_scheduler_init.h&gt;
#include &lt;tbb/pipeline.h&gt;
#include &lt;opencv2/opencv.hpp&gt;
#include &lt;opencv2/highgui/highgui.hpp&gt;
#include &lt;opencv2/imgproc.hpp&gt;
</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">heavy</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span> <span class="n">src</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span> <span class="n">dst</span><span class="p">){</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">mid1</span><span class="p">,</span> <span class="n">mid2</span><span class="p">;</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mid1</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2GRAY</span><span class="p">);</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">threshold</span><span class="p">(</span><span class="n">mid1</span><span class="p">,</span> <span class="n">mid2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">THRESH_BINARY</span><span class="p">);</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">mid2</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">COLOR_GRAY2BGR</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main_naive</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">){</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">src</span><span class="p">;</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">dst</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">src</span><span class="p">)){</span>
    <span class="n">heavy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
    <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main_mutex</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">){</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="p">;</span>
  <span class="n">mutex</span> <span class="n">src_que_mutex</span><span class="p">;</span>
  <span class="n">queue</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span> <span class="n">src_que</span><span class="p">;</span>
  <span class="n">mutex</span> <span class="n">dst_que_mutex</span><span class="p">;</span>
  <span class="n">queue</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span> <span class="n">dst_que</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">source_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="k">auto</span> <span class="n">src</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
      <span class="k">if</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)){</span>
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">src_que_mutex</span><span class="p">};</span>
        <span class="n">src_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">src_que_mutex</span><span class="p">};</span>
        <span class="n">src_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>
  <span class="k">auto</span> <span class="n">serial_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">src</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
      <span class="p">{</span> 
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">src_que_mutex</span><span class="p">};</span>
        <span class="k">if</span><span class="p">(</span><span class="n">src_que</span><span class="p">.</span><span class="n">empty</span><span class="p">()){</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">src_que</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
        <span class="n">src_que</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">){</span>
        <span class="k">auto</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
        <span class="n">heavy</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
        <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
        <span class="p">{</span> 
          <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">dst_que_mutex</span><span class="p">};</span>
          <span class="n">dst_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">dst_que_mutex</span><span class="p">};</span>
        <span class="n">dst_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>
  <span class="k">auto</span> <span class="n">sink_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
      <span class="p">{</span> 
        <span class="k">auto</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">dst_que_mutex</span><span class="p">};</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dst_que</span><span class="p">.</span><span class="n">empty</span><span class="p">()){</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">dst_que</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
        <span class="n">dst_que</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">dst</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">){</span>
         <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">);</span>
         <span class="k">delete</span> <span class="n">dst</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>
  <span class="n">source_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="n">serial_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="n">sink_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main_lockfree</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">){</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">boost</span><span class="o">::</span><span class="n">lockfree</span><span class="o">::</span><span class="n">queue</span><span class="p">;</span>
  <span class="n">queue</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span> <span class="n">src_que</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="n">queue</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span> <span class="n">dst_que</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">source_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]{</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">src</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
      <span class="k">if</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)){</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">src_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">src</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">};</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">src_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">auto</span> <span class="n">serial_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">src</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">src_que</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">src</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">){</span>
        <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
        <span class="n">heavy</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
        <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">dst_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">dst</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">dst_que</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>
  <span class="k">auto</span> <span class="n">sink_th</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">{[</span><span class="o">&amp;</span><span class="p">](){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
      <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">dst_que</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dst</span><span class="p">)){</span> <span class="s">"retry"</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">dst</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">){</span>
        <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">);</span>
        <span class="k">delete</span> <span class="n">dst</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}};</span>
  <span class="n">source_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="n">serial_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="n">sink_th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Source</span><span class="o">:</span> <span class="k">public</span> <span class="n">tbb</span><span class="o">::</span><span class="n">filter</span> <span class="p">{</span>
<span class="nl">private:</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span> <span class="n">reader</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="n">Source</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">)</span><span class="o">:</span> <span class="n">filter</span><span class="p">(</span><span class="n">tbb</span><span class="o">::</span><span class="n">filter</span><span class="o">::</span><span class="n">mode</span><span class="o">::</span><span class="n">serial_in_order</span><span class="p">),</span> <span class="n">reader</span><span class="p">{</span><span class="n">reader</span><span class="p">}</span> <span class="p">{};</span>
  <span class="kt">void</span><span class="o">*</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">void</span><span class="o">*</span><span class="p">){</span>
    <span class="k">auto</span> <span class="n">src</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)){</span>
      <span class="k">return</span> <span class="n">src</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">SerialFilter</span><span class="o">:</span> <span class="k">public</span> <span class="n">tbb</span><span class="o">::</span><span class="n">filter</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">SerialFilter</span><span class="p">()</span><span class="o">:</span> <span class="n">filter</span><span class="p">(</span><span class="n">tbb</span><span class="o">::</span><span class="n">filter</span><span class="o">::</span><span class="n">mode</span><span class="o">::</span><span class="n">serial_in_order</span><span class="p">)</span> <span class="p">{};</span>
  <span class="kt">void</span><span class="o">*</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">){</span>
    <span class="k">auto</span> <span class="n">src</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{};</span>
    <span class="n">heavy</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">);</span>
    <span class="k">delete</span> <span class="n">src</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Sink</span><span class="o">:</span> <span class="k">public</span> <span class="n">tbb</span><span class="o">::</span><span class="n">filter</span> <span class="p">{</span>
<span class="nl">private:</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span> <span class="n">writer</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="n">Sink</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">)</span><span class="o">:</span> <span class="n">filter</span><span class="p">{</span><span class="n">tbb</span><span class="o">::</span><span class="n">filter</span><span class="o">::</span><span class="n">mode</span><span class="o">::</span><span class="n">serial_in_order</span><span class="p">},</span> <span class="n">writer</span><span class="p">{</span><span class="n">writer</span><span class="p">}</span> <span class="p">{};</span>
  <span class="kt">void</span><span class="o">*</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">){</span>
    <span class="k">auto</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
    <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">);</span>
    <span class="k">delete</span> <span class="n">dst</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main_tbb</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="o">&amp;</span> <span class="n">reader</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="o">&amp;</span> <span class="n">writer</span><span class="p">){</span>
  <span class="n">tbb</span><span class="o">::</span><span class="n">task_scheduler_init</span> <span class="n">init</span><span class="p">;</span>
  <span class="n">tbb</span><span class="o">::</span><span class="n">pipeline</span> <span class="n">pipe</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">{</span><span class="n">reader</span><span class="p">};</span>
  <span class="k">auto</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">SerialFilter</span><span class="p">{};</span>
  <span class="k">auto</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">Sink</span><span class="p">{</span><span class="n">writer</span><span class="p">};</span>
  <span class="n">pipe</span><span class="p">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
  <span class="n">pipe</span><span class="p">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
  <span class="n">pipe</span><span class="p">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
  <span class="n">pipe</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
  <span class="n">string</span> <span class="n">INPUT_VIDEO_PATH</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">OUTPUT_VIDEO_PATH</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">PIPELINE_MODE</span><span class="p">;</span>
  <span class="k">namespace</span> <span class="n">po</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">program_options</span><span class="p">;</span>
  <span class="n">po</span><span class="o">::</span><span class="n">options_description</span> <span class="n">opt</span><span class="p">(</span><span class="s">"option"</span><span class="p">);</span>
  <span class="n">opt</span><span class="p">.</span><span class="n">add_options</span><span class="p">()</span>
    <span class="p">(</span><span class="s">"input,i"</span><span class="p">,</span> <span class="n">po</span><span class="o">::</span><span class="n">value</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">INPUT_VIDEO_PATH</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">required</span><span class="p">(),</span> <span class="s">"input video file path"</span><span class="p">)</span>
    <span class="p">(</span><span class="s">"output,o"</span><span class="p">,</span> <span class="n">po</span><span class="o">::</span><span class="n">value</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OUTPUT_VIDEO_PATH</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">required</span><span class="p">(),</span> <span class="s">"output mp4 video file path if you need"</span><span class="p">)</span>
    <span class="p">(</span><span class="s">"mode"</span><span class="p">,</span> <span class="n">po</span><span class="o">::</span><span class="n">value</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PIPELINE_MODE</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">"0: naive, 1: mutex, 2: lockfree, 3: tbb mode"</span><span class="p">)</span>
    <span class="p">(</span><span class="s">"help,h"</span><span class="p">,</span> <span class="s">"show this menu"</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">vm</span> <span class="o">=</span> <span class="n">po</span><span class="o">::</span><span class="n">variables_map</span><span class="p">{};</span>
  <span class="k">try</span><span class="p">{</span>
    <span class="n">po</span><span class="o">::</span><span class="n">store</span><span class="p">(</span><span class="n">po</span><span class="o">::</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">opt</span><span class="p">),</span> <span class="n">vm</span><span class="p">);</span>
    <span class="n">po</span><span class="o">::</span><span class="n">notify</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Error: "</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">opt</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// put help</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">vm</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="s">"help"</span><span class="p">)</span>  <span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">opt</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// put help</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">auto</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="p">{</span> <span class="n">INPUT_VIDEO_PATH</span> <span class="p">};</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">reader</span><span class="p">.</span><span class="n">isOpened</span><span class="p">()){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"C++: reader cannot opened</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_WIDTH</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_HEIGHT</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">fps</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FPS</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="p">{</span> <span class="s">"appsrc ! videoconvert ! x264enc ! mp4mux ! filesink location="</span> <span class="o">+</span> <span class="n">OUTPUT_VIDEO_PATH</span> <span class="o">+</span> <span class="s">"  "</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">{</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="p">},</span> <span class="nb">true</span><span class="p">};</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">PIPELINE_MODE</span><span class="p">){</span>
    <span class="k">case</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">main_naive</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">);</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">main_mutex</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">);</span>
    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">main_lockfree</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">);</span>
    <span class="k">case</span> <span class="mi">3</span><span class="p">:</span> <span class="k">return</span> <span class="n">main_tbb</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></div></div>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre>g++-7 main.cpp <span class="nt">-std</span><span class="o">=</span>c++1z <span class="nt">-O3</span> <span class="nt">-Wall</span> <span class="nt">-v</span> <span class="sb">`</span>pkg-config <span class="nt">--libs</span> opencv<span class="sb">`</span> <span class="nt">-lboost_program_options</span> <span class="nt">-ltbb</span> <span class="nt">-lpthread</span>

<span class="nb">time</span> ./a.out <span class="nt">--input</span> big_buck_bunny_720p_30mb.mp4 <span class="nt">--output</span> naive.mp4 <span class="nt">--mode</span> 0
<span class="nb">time</span> ./a.out <span class="nt">--input</span> big_buck_bunny_720p_30mb.mp4 <span class="nt">--output</span> mutex.mp4 <span class="nt">--mode</span> 1
<span class="nb">time</span> ./a.out <span class="nt">--input</span> big_buck_bunny_720p_30mb.mp4 <span class="nt">--output</span> lockfree.mp4 <span class="nt">--mode</span> 2
<span class="nb">time</span> ./a.out <span class="nt">--input</span> big_buck_bunny_720p_30mb.mp4 <span class="nt">--output</span> tbb.mp4 <span class="nt">--mode</span> 3
</pre></div></div>
