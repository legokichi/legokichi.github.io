<p><a href="https://qiita.com/legokichi/items/5d6344314ab6d6633554" id="reference-4687f5cb2020418c890a">WebAssembly Advent Calendar 2018 12日目 Rust における wasm-bindgen と wasm-pack と cargo-web と stdweb の違い</a> の続編</p>

<p>あれから一年経ったので rustasync と rustwasm の進捗をチェック！</p>

<h1>
<span id="wasm-pack-で-js-の-promise-を-await-できる非同期-rust-を書いて-nodejs-で動かす" class="fragment"></span><a href="#wasm-pack-%E3%81%A7-js-%E3%81%AE-promise-%E3%82%92-await-%E3%81%A7%E3%81%8D%E3%82%8B%E9%9D%9E%E5%90%8C%E6%9C%9F-rust-%E3%82%92%E6%9B%B8%E3%81%84%E3%81%A6-nodejs-%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99"><i class="fa fa-link"></i></a>wasm-pack で JS の Promise を await できる非同期 Rust を書いて node.js で動かす</h1>

<h2>
<span id="setup" class="fragment"></span><a href="#setup"><i class="fa fa-link"></i></a>setup</h2>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre>rustup default nightly
rustup target add wasm32-unknown-unknown
curl https://rustwasm.github.io/wasm-pack/installer/init.sh <span class="nt">-sSf</span> | sh
cargo <span class="nb">install </span>cargo-generate
cargo generate <span class="nt">--git</span> https://github.com/rustwasm/wasm-pack-template
</pre></div></div>

<ul>
<li>nightly, wasm32-unknown-unknown, wasm-pack, cargo-generate をインストールして wasm-pack を使うためのディレクトリを生成する</li>
<li><a href="https://rustwasm.github.io/docs/wasm-pack/tutorials/npm-browser-packages/getting-started.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-pack/tutorials/npm-browser-packages/getting-started.html</a></li>
<li>1.41.0-nightly</li>
</ul>

<h2>
<span id="cargotoml-の構成" class="fragment"></span><a href="#cargotoml-%E3%81%AE%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>Cargo.toml の構成</h2>

<div class="code-frame" data-lang="toml">
<div class="code-lang"><span class="bold">Cargo.toml</span></div>
<div class="highlight"><pre><span class="nn">[package]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"rust-wasm-nodejs"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.1.0"</span>
<span class="py">edition</span> <span class="p">=</span> <span class="s">"2018"</span>

<span class="nn">[lib]</span>
<span class="py">crate-type</span> <span class="p">=</span> <span class="p">[</span><span class="s">"cdylib"</span><span class="p">,</span> <span class="s">"rlib"</span><span class="p">]</span>

<span class="nn">[features]</span>
<span class="py">default</span> <span class="p">=</span> <span class="p">[]</span>

<span class="nn">[dependencies]</span>
<span class="nn">wasm-bindgen</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.2.55"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="p">[</span><span class="s">"serde-serialize"</span><span class="p">,</span> <span class="s">"nightly"</span><span class="p">]</span> <span class="p">}</span>
<span class="py">wasm-bindgen-futures</span> <span class="p">=</span> <span class="s">"0.4.5"</span>
<span class="py">js-sys</span> <span class="p">=</span> <span class="s">"0.3.32"</span>
<span class="nn">web-sys</span> <span class="o">=</span> <span class="p">{</span> <span class="py">vesrion</span> <span class="p">=</span> <span class="s">"0.3.32"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="nn">["console"]</span> <span class="p">}</span>
<span class="nn">serde</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"1"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="nn">["derive"]</span> <span class="p">}</span>
</pre></div>
</div>

<ul>
<li>
<code>wasm-bindgen = { version = "0.2", features = ["serde-serialize"] }</code> について

<ul>
<li><a href="https://rustwasm.github.io/docs/wasm-bindgen/reference/arbitrary-data-with-serde.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-bindgen/reference/arbitrary-data-with-serde.html</a></li>
<li><a href="https://docs.rs/wasm-bindgen/0.2.55/wasm_bindgen/" class="autolink" rel="nofollow noopener" target="_blank">https://docs.rs/wasm-bindgen/0.2.55/wasm_bindgen/</a></li>
<li><a href="https://github.com/rustwasm/wasm-bindgen/blob/b9c93a3c24f25456c9867b4fe50ad19fb844a6f1/Cargo.toml#L26" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/rustwasm/wasm-bindgen/blob/b9c93a3c24f25456c9867b4fe50ad19fb844a6f1/Cargo.toml#L26</a></li>
</ul>
</li>
<li>
<code>js-sys</code> について

<ul>
<li>
<code>js_sys::Promise</code> が生えてる</li>
<li><a href="https://github.com/rustwasm/wasm-bindgen/tree/b9c93a3c24f25456c9867b4fe50ad19fb844a6f1/crates/js-sys" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/rustwasm/wasm-bindgen/tree/b9c93a3c24f25456c9867b4fe50ad19fb844a6f1/crates/js-sys</a></li>
<li><a href="https://docs.rs/js-sys/0.3.32/js_sys/" class="autolink" rel="nofollow noopener" target="_blank">https://docs.rs/js-sys/0.3.32/js_sys/</a></li>
</ul>
</li>
<li>
<code>web-sys = { vesrion = "0.3", features = ["console"] }</code> について

<ul>
<li>今回は nodejs で動かすので <code>console</code> だけ有効にする</li>
<li><a href="https://github.com/rustwasm/wasm-bindgen/blob/b9c93a3c24f25456c9867b4fe50ad19fb844a6f1/crates/web-sys/Cargo.toml#L1288" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/rustwasm/wasm-bindgen/blob/b9c93a3c24f25456c9867b4fe50ad19fb844a6f1/crates/web-sys/Cargo.toml#L1288</a></li>
<li><a href="https://docs.rs/web-sys/0.3.32/web_sys/" class="autolink" rel="nofollow noopener" target="_blank">https://docs.rs/web-sys/0.3.32/web_sys/</a></li>
</ul>
</li>
<li>
<code>wasm-bindgen-futures</code> について

<ul>
<li>
<code>wasm_bindgen_futures::JsFuture</code> が生えてる</li>
<li><a href="https://github.com/rustwasm/wasm-bindgen/tree/b9c93a3c24f25456c9867b4fe50ad19fb844a6f1/crates/futures" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/rustwasm/wasm-bindgen/tree/b9c93a3c24f25456c9867b4fe50ad19fb844a6f1/crates/futures</a></li>
<li><a href="https://docs.rs/wasm-bindgen-futures/0.4.5/wasm_bindgen_futures/index.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.rs/wasm-bindgen-futures/0.4.5/wasm_bindgen_futures/index.html</a></li>
</ul>
</li>
</ul>

<h2>
<span id="settimeout-を-promise-で包んで-wasm-rust-に渡す" class="fragment"></span><a href="#settimeout-%E3%82%92-promise-%E3%81%A7%E5%8C%85%E3%82%93%E3%81%A7-wasm-rust-%E3%81%AB%E6%B8%A1%E3%81%99"><i class="fa fa-link"></i></a>setTimeout を Promise で包んで wasm rust に渡す</h2>

<div class="code-frame" data-lang="rust">
<div class="code-lang"><span class="bold">src/lib.rs</span></div>
<div class="highlight"><pre><span class="k">use</span> <span class="nn">serde</span><span class="p">::</span><span class="n">Deserialize</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">wasm_bindgen</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">wasm_bindgen_futures</span><span class="p">::</span><span class="n">JsFuture</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">js_sys</span><span class="p">::{</span><span class="n">Promise</span><span class="p">,</span> <span class="n">Error</span><span class="p">};</span>

<span class="nd">#[wasm_bindgen(inline_js</span> <span class="nd">=</span> <span class="s">"module.exports.sleep = function sleep(ms) { return new Promise((resolve)=&gt; setTimeout(resolve, ms)); }"</span><span class="nd">)]</span>
<span class="k">extern</span> <span class="s">"C"</span>  <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">ms</span><span class="p">:</span> <span class="nb">f64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">#[derive(Deserialize)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Opt</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">count</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">f64</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">#[wasm_bindgen]</span>
<span class="k">pub</span> <span class="k">async</span> <span class="k">fn</span> <span class="nf">handler</span><span class="p">(</span><span class="n">opt</span><span class="p">:</span> <span class="n">JsValue</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">JsValue</span><span class="p">,</span> <span class="n">JsValue</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">Opt</span><span class="p">{</span> <span class="n">count</span><span class="p">,</span> <span class="n">wait</span> <span class="p">}</span> <span class="o">=</span> <span class="n">opt</span><span class="nf">.into_serde</span><span class="p">()</span>
        <span class="nf">.map_err</span><span class="p">(|</span><span class="n">err</span><span class="p">|</span> <span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">err</span><span class="p">))))</span><span class="o">?</span><span class="p">;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="mi">0_u32</span><span class="o">..</span><span class="n">count</span> <span class="p">{</span>
        <span class="nn">JsFuture</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nf">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">))</span><span class="py">.await</span><span class="o">?</span><span class="p">;</span>
        <span class="nn">web_sys</span><span class="p">::</span><span class="nn">console</span><span class="p">::</span><span class="nf">log_1</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="nf">.into</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="nf">Ok</span><span class="p">(</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">undefined</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>

<ul>
<li>
<code>opt.into_serde()</code> について

<ul>
<li><a href="https://rustwasm.github.io/wasm-bindgen/api/wasm_bindgen/struct.JsValue.html#method.into_serde" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/wasm-bindgen/api/wasm_bindgen/struct.JsValue.html#method.into_serde</a></li>
<li><a href="https://rustwasm.github.io/docs/wasm-bindgen/reference/arbitrary-data-with-serde.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-bindgen/reference/arbitrary-data-with-serde.html</a></li>
</ul>
</li>
<li>
<code>js_sys::Promise</code> について

<ul>
<li><a href="https://docs.rs/js-sys/0.3.32/js_sys/struct.Promise.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.rs/js-sys/0.3.32/js_sys/struct.Promise.html</a></li>
</ul>
</li>
<li>
<code>Closure</code> について

<ul>
<li><a href="https://docs.rs/wasm-bindgen/0.2.55/wasm_bindgen/closure/struct.Closure.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.rs/wasm-bindgen/0.2.55/wasm_bindgen/closure/struct.Closure.html</a></li>
</ul>
</li>
<li>
<code>#[wasm_bindgen(inline_js = "...")]</code> について

<ul>
<li>wasm-bindgen の inline js を wasm の import 関数に割り当てる機能</li>
<li>他に <code>#[wasm_bindgen(module = "aws-sdk-js")]</code> みたいに書くこともできる</li>
<li><a href="https://rustwasm.github.io/docs/wasm-bindgen/contributing/design/importing-js.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-bindgen/contributing/design/importing-js.html</a></li>
<li><a href="https://rustwasm.github.io/docs/wasm-bindgen/reference/attributes/on-js-imports/module.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-bindgen/reference/attributes/on-js-imports/module.html</a></li>
<li><a href="https://rustwasm.github.io/docs/wasm-bindgen/reference/attributes/on-js-imports/raw_module.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-bindgen/reference/attributes/on-js-imports/raw_module.html</a></li>
</ul>
</li>
</ul>

<h2>
<span id="ビルド" class="fragment"></span><a href="#%E3%83%93%E3%83%AB%E3%83%89"><i class="fa fa-link"></i></a>ビルド</h2>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre>wasm-pack build <span class="nt">-t</span> nodejs
</pre></div></div>

<ul>
<li>
<code>wasm-pack build -t nodejs</code> について

<ul>
<li>nodejs は 8.0.0 あたりから WebAssembly に対応している</li>
<li><a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly" class="autolink" rel="nofollow noopener" target="_blank">https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly</a></li>
<li><a href="https://rustwasm.github.io/docs/wasm-pack/commands/build.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-pack/commands/build.html</a></li>
</ul>
</li>
</ul>

<h2>
<span id="nodejs-から呼ぶ" class="fragment"></span><a href="#nodejs-%E3%81%8B%E3%82%89%E5%91%BC%E3%81%B6"><i class="fa fa-link"></i></a>nodejs から呼ぶ</h2>

<p>node v12.13.1</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">example.js</span></div>
<div class="highlight"><pre><span class="kd">const</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./pkg</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">pkg</span><span class="p">.</span><span class="nx">handler</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="na">wait</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
</div>

<p>出力</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>0
1
2
3
4
5
6
7
8
9
undefined
</pre></div></div>

<h2>
<span id="sleep-settimeout-関数を-wasm-rust-の引数として渡す" class="fragment"></span><a href="#sleep-settimeout-%E9%96%A2%E6%95%B0%E3%82%92-wasm-rust-%E3%81%AE%E5%BC%95%E6%95%B0%E3%81%A8%E3%81%97%E3%81%A6%E6%B8%A1%E3%81%99"><i class="fa fa-link"></i></a>sleep (setTimeout) 関数を wasm rust の引数として渡す</h2>

<p>wasm の関数に 非同期 IO 関数を渡したい。<br>
wasm への入出力には通常 wasm-bindgen の <code>serde-serialize</code> を使う。<br>
しかしこれは一旦 JS オブジェクトを JSON 文字列に変換してから Rust の serde でデシリアライズしているため、 JS の関数を渡すことはできない。<br>
一方で wasm-bindgen では JsValue (JS の any 値) が渡せるため、<br>
型キャストすることで JsValue を Function として呼ぶことができる。</p>

<p>ここでは <code>impl TryInto&lt;JsValue&gt; for Response</code> と <code>impl TryFrom&lt;JsValue&gt; for Request</code> を実装して Rust の値と JsValue 値の変換できるようにした</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre><span class="k">use</span> <span class="nn">serde</span><span class="p">::{</span><span class="n">Deserialize</span><span class="p">,</span> <span class="n">Serialize</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">wasm_bindgen</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">wasm_bindgen</span><span class="p">::</span><span class="n">JsCast</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">wasm_bindgen_futures</span><span class="p">::</span><span class="n">JsFuture</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">js_sys</span><span class="p">::{</span><span class="n">Promise</span><span class="p">,</span> <span class="n">Error</span><span class="p">,</span> <span class="n">Function</span><span class="p">,</span> <span class="n">Reflect</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">web_sys</span><span class="p">::</span><span class="n">console</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">convert</span><span class="p">::{</span><span class="n">TryFrom</span><span class="p">,</span> <span class="n">TryInto</span><span class="p">};</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">Request</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">count</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">f64</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">sleep</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">Fn</span><span class="p">(</span><span class="nb">f64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">JsFuture</span><span class="p">,</span> <span class="n">JsValue</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">TryFrom</span><span class="o">&lt;</span><span class="n">JsValue</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">Request</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">JsValue</span><span class="p">;</span>
    <span class="k">fn</span> <span class="nf">try_from</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="n">JsValue</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="nn">Self</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nd">#[derive(Deserialize)]</span>
        <span class="k">pub</span> <span class="k">struct</span> <span class="mi">_</span><span class="n">Request</span> <span class="p">{</span>
            <span class="k">pub</span> <span class="n">count</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
            <span class="k">pub</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">f64</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">let</span> <span class="n">sleep</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">cb</span> <span class="o">=</span> <span class="nn">Reflect</span><span class="p">::</span><span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o</span><span class="p">,</span> <span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="s">"sleep"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
            <span class="k">if</span> <span class="o">!</span><span class="nn">Function</span><span class="p">::</span><span class="nf">instanceof</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"sleep is not function"</span><span class="p">)));</span>
            <span class="p">}</span>
            <span class="nn">Function</span><span class="p">::</span><span class="nf">unchecked_from_js</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
        <span class="p">};</span>
        <span class="k">let</span> <span class="mi">_</span><span class="n">req</span><span class="p">:</span> <span class="mi">_</span><span class="n">Request</span> <span class="o">=</span> <span class="n">o</span><span class="nf">.into_serde</span><span class="p">()</span>
            <span class="nf">.map_err</span><span class="p">(|</span><span class="n">err</span><span class="p">|</span> <span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">err</span><span class="p">)))</span><span class="o">?</span><span class="p">;</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="n">Request</span><span class="p">{</span>
            <span class="n">count</span><span class="p">:</span> <span class="mi">_</span><span class="n">req</span><span class="py">.count</span><span class="p">,</span>
            <span class="n">wait</span><span class="p">:</span> <span class="mi">_</span><span class="n">req</span><span class="py">.wait</span><span class="p">,</span>
            <span class="n">sleep</span><span class="p">:</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">move</span> <span class="p">|</span><span class="n">ms</span><span class="p">|{</span>
                <span class="k">let</span> <span class="n">prm</span> <span class="o">=</span> <span class="n">sleep</span><span class="nf">.call1</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">ms</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
                <span class="k">if</span> <span class="o">!</span><span class="nn">Promise</span><span class="p">::</span><span class="nf">instanceof</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"return value is not instanceof Promise"</span><span class="p">)));</span>
                <span class="p">}</span>
                <span class="nf">Ok</span><span class="p">(</span><span class="nn">JsFuture</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Promise</span><span class="p">::</span><span class="nf">unchecked_from_js</span><span class="p">(</span><span class="n">prm</span><span class="p">)))</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">Response</span> <span class="p">{</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">TryInto</span><span class="o">&lt;</span><span class="n">JsValue</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">Response</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">JsValue</span><span class="p">;</span>
    <span class="k">fn</span> <span class="nf">try_into</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">JsValue</span><span class="p">,</span> <span class="nn">Self</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nd">#[derive(Serialize)]</span>
        <span class="k">pub</span> <span class="k">struct</span> <span class="mi">_</span><span class="n">Response</span> <span class="p">{</span>
        <span class="p">}</span>
        <span class="k">let</span> <span class="n">Response</span> <span class="p">{}</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
        <span class="nn">JsValue</span><span class="p">::</span><span class="nf">from_serde</span><span class="p">(</span><span class="o">&amp;</span><span class="mi">_</span><span class="n">Response</span><span class="p">{})</span>
            <span class="nf">.map_err</span><span class="p">(|</span><span class="n">err</span><span class="p">|</span> <span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">err</span><span class="p">))))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">#[wasm_bindgen]</span>
<span class="k">pub</span> <span class="k">async</span> <span class="k">fn</span> <span class="nf">handler</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">JsValue</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">JsValue</span><span class="p">,</span> <span class="n">JsValue</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nf">set_panic_hook</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">Request</span><span class="p">{</span><span class="n">sleep</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">wait</span><span class="p">}</span> <span class="o">=</span> <span class="nn">Request</span><span class="p">::</span><span class="nf">try_from</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="mi">0_u32</span><span class="o">..</span><span class="n">count</span> <span class="p">{</span>
        <span class="nf">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span><span class="o">?</span><span class="py">.await</span><span class="o">?</span><span class="p">;</span>
        <span class="nn">console</span><span class="p">::</span><span class="nf">log_1</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">i</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="n">Response</span><span class="p">{}</span><span class="nf">.try_into</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_panic_hook</span><span class="p">()</span> <span class="p">{</span>
    <span class="nd">#[cfg(feature</span> <span class="nd">=</span> <span class="s">"console_error_panic_hook"</span><span class="nd">)]</span>
    <span class="nn">console_error_panic_hook</span><span class="p">::</span><span class="nf">set_once</span><span class="p">();</span>
<span class="p">}</span>
</pre></div></div>

<ul>
<li>
<code>Reflect::get</code>, <code>Reflect::set</code> について

<ul>
<li>any な JsValue からプロパティ値の読み書きを試みる</li>
<li><a href="https://rustwasm.github.io/docs/wasm-bindgen/reference/accessing-properties-of-untyped-js-values.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-bindgen/reference/accessing-properties-of-untyped-js-values.html</a></li>
<li><a href="https://rustwasm.github.io/wasm-bindgen/api/js_sys/Reflect/index.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/wasm-bindgen/api/js_sys/Reflect/index.html</a></li>
</ul>
</li>
</ul>

<h2>
<span id="js-側から-sleep-関数を-wasm-rust-に渡してみる" class="fragment"></span><a href="#js-%E5%81%B4%E3%81%8B%E3%82%89-sleep-%E9%96%A2%E6%95%B0%E3%82%92-wasm-rust-%E3%81%AB%E6%B8%A1%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>JS 側から sleep 関数を wasm rust に渡してみる</h2>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">const</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./pkg</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">pkg</span><span class="p">.</span><span class="nx">handler</span><span class="p">({</span>
    <span class="nx">sleep</span><span class="p">(</span><span class="nx">ms</span><span class="p">){</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">));</span> <span class="p">},</span>
    <span class="na">count</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="na">wait</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div></div>

<p>これでうまくうごく。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>0
1
2
3
4
5
6
7
8
9
{}
</pre></div></div>

<h2>
<span id="非同期-io-ストリームを模した-periodic-setinterval-関数を-wasm-rust-に渡す" class="fragment"></span><a href="#%E9%9D%9E%E5%90%8C%E6%9C%9F-io-%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%82%92%E6%A8%A1%E3%81%97%E3%81%9F-periodic-setinterval-%E9%96%A2%E6%95%B0%E3%82%92-wasm-rust-%E3%81%AB%E6%B8%A1%E3%81%99"><i class="fa fa-link"></i></a>非同期 IO ストリームを模した periodic (setInterval) 関数を wasm rust に渡す</h2>

<p>sleep を導入することができたので次は非同期 IO ストリームを模して setInterval をラップしたこんな関数を渡すことを考えてみる</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">const</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./pkg</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">pkg</span><span class="p">.</span><span class="nx">handler2</span><span class="p">({</span>
    <span class="nx">sleep</span><span class="p">(</span><span class="nx">ms</span><span class="p">){</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">));</span> <span class="p">},</span>
    <span class="nx">periodic</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">cb</span><span class="p">){</span>
        <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">tid</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">i</span><span class="o">++</span><span class="p">);</span> <span class="p">},</span> <span class="nx">ms</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">tid</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div></div>

<p>TypeScript ではこう</p>

<div class="code-frame" data-lang="ts"><div class="highlight"><pre><span class="kr">interface</span> <span class="nx">Request</span> <span class="p">{</span>
    <span class="nx">sleep</span><span class="p">(</span><span class="nx">wait</span><span class="p">:</span> <span class="nx">number</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="nx">periodic</span><span class="p">(</span><span class="nx">wait</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">listener</span><span class="p">:</span> <span class="p">(</span><span class="nx">i</span><span class="p">:</span> <span class="nx">number</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">any</span><span class="p">):</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>
<span class="p">}</span>
</pre></div></div>

<p>この JS の引数オブジェクトの型は Rust での型はこんな感じになる</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre><span class="k">pub</span> <span class="k">struct</span> <span class="n">Request</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">sleep</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">Fn</span><span class="p">(</span><span class="nb">f64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">JsFuture</span><span class="p">,</span> <span class="n">JsValue</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">periodic</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">Fn</span><span class="p">(</span><span class="nb">f64</span><span class="p">,</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">FnMut</span><span class="p">(</span><span class="nb">f64</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span>
        <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">FnOnce</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">JsValue</span><span class="p">,</span> <span class="n">JsValue</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">JsValue</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div></div>

<p>例によって JsValue から Rust の型にコンバートする TryFrom を実装する</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre><span class="k">impl</span> <span class="n">TryFrom</span><span class="o">&lt;</span><span class="n">JsValue</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">Request</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">JsValue</span><span class="p">;</span>
    <span class="k">fn</span> <span class="nf">try_from</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="n">JsValue</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="nn">Self</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nd">#[derive(Deserialize)]</span>
        <span class="k">pub</span> <span class="k">struct</span> <span class="mi">_</span><span class="n">Request</span> <span class="p">{</span>
        <span class="p">}</span>
        <span class="k">let</span> <span class="n">sleep</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">cb</span> <span class="o">=</span> <span class="nn">Reflect</span><span class="p">::</span><span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o</span><span class="p">,</span> <span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="s">"sleep"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
            <span class="k">if</span> <span class="o">!</span><span class="nn">Function</span><span class="p">::</span><span class="nf">instanceof</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"sleep is not function"</span><span class="p">)));</span>
            <span class="p">}</span>
            <span class="nn">Function</span><span class="p">::</span><span class="nf">unchecked_from_js</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
        <span class="p">};</span>
        <span class="k">let</span> <span class="n">periodic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">cb</span> <span class="o">=</span> <span class="nn">Reflect</span><span class="p">::</span><span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o</span><span class="p">,</span> <span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="s">"periodic"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
            <span class="k">if</span> <span class="o">!</span><span class="nn">Function</span><span class="p">::</span><span class="nf">instanceof</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"periodic is not function"</span><span class="p">)));</span>
            <span class="p">}</span>
            <span class="nn">Function</span><span class="p">::</span><span class="nf">unchecked_from_js</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
        <span class="p">};</span>
        <span class="k">let</span> <span class="mi">_</span><span class="n">req</span><span class="p">:</span> <span class="mi">_</span><span class="n">Request</span> <span class="o">=</span> <span class="n">o</span><span class="nf">.into_serde</span><span class="p">()</span>
            <span class="nf">.map_err</span><span class="p">(|</span><span class="n">err</span><span class="p">|</span> <span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">err</span><span class="p">)))</span><span class="o">?</span><span class="p">;</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="n">Request</span><span class="p">{</span>
            <span class="n">sleep</span><span class="p">:</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">move</span> <span class="p">|</span><span class="n">ms</span><span class="p">|{</span>
                <span class="k">let</span> <span class="n">prm</span> <span class="o">=</span> <span class="n">sleep</span><span class="nf">.call1</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">ms</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
                <span class="k">if</span> <span class="o">!</span><span class="nn">Promise</span><span class="p">::</span><span class="nf">instanceof</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prm</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"return value is not instanceof Promise"</span><span class="p">)));</span>
                <span class="p">}</span>
                <span class="nf">Ok</span><span class="p">(</span><span class="nn">JsFuture</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Promise</span><span class="p">::</span><span class="nf">unchecked_from_js</span><span class="p">(</span><span class="n">prm</span><span class="p">)))</span>
            <span class="p">}),</span>
            <span class="n">periodic</span><span class="p">:</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">move</span> <span class="p">|</span><span class="n">wait</span><span class="p">,</span> <span class="n">cb</span><span class="p">|{</span>
                <span class="k">let</span> <span class="n">cb</span> <span class="o">=</span> <span class="nn">Closure</span><span class="p">::</span><span class="nf">wrap</span><span class="p">(</span><span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="k">as</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">FnMut</span><span class="p">(</span><span class="nb">f64</span><span class="p">)</span><span class="o">&gt;</span><span class="p">);</span>
                <span class="k">let</span> <span class="n">stopfn</span> <span class="o">=</span> <span class="n">periodic</span><span class="nf">.call2</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">wait</span><span class="p">),</span> <span class="nn">AsRef</span><span class="p">::</span><span class="o">&lt;</span><span class="n">JsValue</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">as_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
                <span class="k">if</span> <span class="o">!</span><span class="nn">Function</span><span class="p">::</span><span class="nf">instanceof</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stopfn</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"return value is not instanceof Function"</span><span class="p">)));</span>
                <span class="p">}</span>
                <span class="k">let</span> <span class="n">stopfn</span> <span class="o">=</span> <span class="nn">Function</span><span class="p">::</span><span class="nf">unchecked_from_js</span><span class="p">(</span><span class="n">stopfn</span><span class="p">);</span>
                <span class="nf">Ok</span><span class="p">(</span><span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">move</span> <span class="p">||{</span>
                    <span class="k">let</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">stopfn</span><span class="nf">.call0</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="n">NULL</span><span class="p">);</span>
                    <span class="n">cb</span><span class="nf">.forget</span><span class="p">();</span>
                    <span class="n">ret</span>
                <span class="p">}))</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<ul>
<li>periodic を rust のクロージャに変換しているところ <code>let cb = Closure::&lt;dyn FnMut(f64)&gt;::new(cb);</code> で 作った cb を 最後 <code>cb.forget();</code> としているところに注意

<ul>
<li>ここでは JS の世界の setInterval の引数として Rust の <code>Box&lt;dyn FnMut(f64)&gt;</code> クロージャを wasm のヒープに置いて <code>wasm_bindgen::closure::Closure</code> で包んで渡している</li>
<li>このヒープ上の <code>Box&lt;dyn FnMut(f64)&gt;</code> クロージャを最後 forget させるのを忘れるとメモリリークになる</li>
<li><a href="https://rustwasm.github.io/wasm-bindgen/reference/passing-rust-closures-to-js.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/wasm-bindgen/reference/passing-rust-closures-to-js.html</a></li>
<li><a href="https://docs.rs/wasm-bindgen/0.2.55/wasm_bindgen/closure/struct.Closure.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.rs/wasm-bindgen/0.2.55/wasm_bindgen/closure/struct.Closure.html</a></li>
</ul>
</li>
<li>
<code>js_sys::Function</code> の引数は <code>&amp;JsValue</code> が要求されるので <code>wasm_bindgen::closure::Closure</code> を AsRef を使って <code>&amp;JsValue</code> にアップキャストしている</li>
</ul>

<p>ここまできれいにRust のコードに包むと使い勝手はふつうの Rust コードとほとんど変わらない</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre><span class="nd">#[wasm_bindgen]</span>
<span class="k">pub</span> <span class="k">async</span> <span class="k">fn</span> <span class="nf">handler</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">JsValue</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">JsValue</span><span class="p">,</span> <span class="n">JsValue</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nf">set_panic_hook</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">Request</span><span class="p">{</span><span class="n">periodic</span><span class="p">,</span> <span class="n">sleep</span><span class="p">}</span> <span class="o">=</span> <span class="nn">Request</span><span class="p">::</span><span class="nf">try_from</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">stop</span> <span class="o">=</span> <span class="nf">periodic</span><span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(|</span><span class="n">i</span><span class="p">|{</span>
        <span class="nn">console</span><span class="p">::</span><span class="nf">log_1</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">i</span><span class="p">)));</span>
    <span class="p">}))</span><span class="o">?</span><span class="p">;</span>

    <span class="nf">sleep</span><span class="p">(</span><span class="mf">3000.0</span><span class="p">)</span><span class="o">?</span><span class="py">.await</span><span class="o">?</span><span class="p">;</span>

    <span class="nf">stop</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

    <span class="n">Response</span><span class="p">{}</span><span class="nf">.try_into</span><span class="p">()</span>
<span class="p">}</span>
</pre></div></div>

<p>実行すると 3 秒間コンソールに数字が流れるようになる。</p>

<h2>
<span id="所感" class="fragment"></span><a href="#%E6%89%80%E6%84%9F"><i class="fa fa-link"></i></a>所感</h2>

<ul>
<li>ここまで楽に書けるといよいよ実用できそうな気持ちがしてくる</li>
<li>
<code>aws-sdk-js</code> を <code>wasm-bindgen</code> で wasm rust の世界に取り込んで aws lambda nodejs v12 runtime で実行したりできると個人的に嬉しい</li>
<li>wasm-bindgen での async の扱いの詳細はこちら

<ul>
<li><a href="https://rustwasm.github.io/wasm-bindgen/reference/js-promises-and-rust-futures.html?highlight=async#return-values-of-async-fn" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/wasm-bindgen/reference/js-promises-and-rust-futures.html?highlight=async#return-values-of-async-fn</a></li>
</ul>
</li>
</ul>

<h2>
<span id="その他メモ" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%83%A1%E3%83%A2"><i class="fa fa-link"></i></a>その他メモ</h2>

<ul>
<li>wasm-pack-template についてくる <code>wee_alloc</code> について

<ul>
<li>rust をそのまま wasm にするとデフォルトアロケータ <code>dlmalloc</code> (の移植版) のランタイムが wasm ファイルのうち 10 KB を消費してしまう</li>
<li>
<code>wee_alloc</code> に切り替えると速度を犠牲に wasm のファイルサイズを削減できる</li>
<li><a href="https://rustwasm.github.io/docs/wasm-pack/tutorials/npm-browser-packages/template-deep-dive/wee_alloc.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-pack/tutorials/npm-browser-packages/template-deep-dive/wee_alloc.html</a></li>
<li><a href="https://rustwasm.github.io/docs/book/reference/code-size.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/book/reference/code-size.html</a></li>
<li><a href="https://github.com/rustwasm/wee_alloc" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/rustwasm/wee_alloc</a></li>
</ul>
</li>
<li>wasm-pack-template についてくる <code>utils::set_panic_hook</code> と <code>console_error_panic_hook</code> について

<ul>
<li>wasm 内の rust のスタックトレースを記録しパニック時に <code>console.error</code> に吐くことができるようになる便利機能</li>
<li><a href="https://rustwasm.github.io/docs/wasm-pack/tutorials/npm-browser-packages/template-deep-dive/src-utils-rs.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/docs/wasm-pack/tutorials/npm-browser-packages/template-deep-dive/src-utils-rs.html</a></li>
<li><a href="https://github.com/rustwasm/console_error_panic_hook" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/rustwasm/console_error_panic_hook</a></li>
</ul>
</li>
<li>serde-wasm-bindgen について

<ul>
<li>wasm-bindgen 付属の <code>from_serde</code> , <code>to_serde</code> は JsValue を JSON 文字列を介して rust の世界に持ってきている</li>
<li>serde-wasm-bindgen を使うと JsValue から直接 rust の値への変換をよしなに試みるようになる</li>
<li>実行速度は JSON 文字列を介する場合と比べてもケースバイケースで早くなったり遅くなったりするようだ</li>
<li><strong>関数のデシリアライズはできない</strong></li>
<li><a href="https://github.com/cloudflare/serde-wasm-bindgen" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/cloudflare/serde-wasm-bindgen</a></li>
<li><a href="https://docs.rs/serde-wasm-bindgen/0.1.3/serde_wasm_bindgen/index.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.rs/serde-wasm-bindgen/0.1.3/serde_wasm_bindgen/index.html</a></li>
</ul>
</li>
</ul>
