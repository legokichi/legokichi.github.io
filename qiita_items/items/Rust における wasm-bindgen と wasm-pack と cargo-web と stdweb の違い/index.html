
<h1>
<span id="rust-ã«ãŠã‘ã‚‹-wasm-bindgen-ã¨-wasm-pack-ã¨-cargo-web-ã¨-stdweb-ã®é•ã„" class="fragment"></span><a href="#rust-%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B-wasm-bindgen-%E3%81%A8-wasm-pack-%E3%81%A8-cargo-web-%E3%81%A8-stdweb-%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>Rust ã«ãŠã‘ã‚‹ wasm-bindgen ã¨ wasm-pack ã¨ cargo-web ã¨ stdweb ã®é•ã„</h1>

<p>â€»ã“ã‚Œã¯ <a href="https://qiita.com/advent-calendar/2018/wasm">WebAssembly Advent Calendar 2018</a> ã® 12 æ—¥ç›®ã®è¨˜äº‹ã§ã™<br>
â€»ã“ã“ã§ã®ä½œæ¥­ã¯ã™ã¹ã¦ nightly ã‚’å‰æã¨ã—ã¦ã„ã¾ã™</p>

<h2>
<span id="ç³»çµ±ã®é•ã„" class="fragment"></span><a href="#%E7%B3%BB%E7%B5%B1%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>ç³»çµ±ã®é•ã„</h2>

<p>Rust ã‹ã‚‰ wasm ã¸ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã«ã¯ emscripten ã‚’ä½¿ã†æ–¹æ³•ã¨ã€ wasm-bindgen ã‚’ä½¿ã†æ–¹æ³•ã®ï¼’ã¤ã‚ã‚Šã¾ã™</p>

<h3>
<span id="emscripten-ç³»çµ±" class="fragment"></span><a href="#emscripten-%E7%B3%BB%E7%B5%B1"><i class="fa fa-link"></i></a>emscripten ç³»çµ±</h3>

<ul>
<li>ã‚‚ã¨ã‚‚ã¨ã¯ clang ã®åã„ãŸ LLVMIR ã‹ã‚‰åŒç­‰ã® JavaScript ã‚’å‡ºåŠ›ã§ãã‚‹ãƒ„ãƒ¼ãƒ«</li>
<li>å¾Œã« asm.js , wasm ã‚‚å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ</li>
<li>libc ç›¸å½“ã® system call ãŒ JavaScript ã®ä¸–ç•Œã§ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã§ãã‚‹(ex. FileSystem</li>
<li>æ—¢å­˜ã® C/C++ ã§æ›¸ã‹ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ãã‚ˆã†ã«å¤‰æ›ã™ã‚‹ã®ãŒç›®çš„</li>
<li>C/C++/Rust ã‹ã‚‰ JavaScript ã‚’å‘¼ã³å‡ºã™ã®ãŒä¸»ãªä½¿ã„æ–¹</li>
<li>ä»Šæ—¥ã¯ã“ã®è©±ã¯ã—ãªã„</li>
</ul>

<h4>
<span id="ä¸»ãªç™»å ´äººç‰©" class="fragment"></span><a href="#%E4%B8%BB%E3%81%AA%E7%99%BB%E5%A0%B4%E4%BA%BA%E7%89%A9"><i class="fa fa-link"></i></a>ä¸»ãªç™»å ´äººç‰©</h4>

<p>ä¸‹ã«è¡Œãã»ã©æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã§ã™</p>

<ul>
<li>emscripten - C/C++ ã‚’ LLVMIR ã‚’çµŒç”±ã—ã¦ asmjs ã‚„ã‚‰ wasm ã‚„ã‚‰ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ« - <a href="https://kripken.github.io/emscripten-site/docs/introducing_emscripten/about_emscripten.html" class="autolink" rel="nofollow noopener" target="_blank">https://kripken.github.io/emscripten-site/docs/introducing_emscripten/about_emscripten.html</a>
</li>
<li>Binaryen - ç‰¹ã« C/C++ ã‚’ emscripten ã‚’ä½¿ã£ã¦ wasm ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ« - <a href="https://github.com/WebAssembly/binaryen" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/WebAssembly/binaryen</a>
</li>
<li>emscripten-sys - Rust ã‹ã‚‰ emscripten ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¸ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãŒå…¥ã£ãŸã‚¯ãƒ¬ãƒ¼ãƒˆ - <a href="https://crates.io/crates/emscripten-sys" class="autolink" rel="nofollow noopener" target="_blank">https://crates.io/crates/emscripten-sys</a>
</li>
<li>stdweb - Rust ã‹ã‚‰ DOM ã‚’æ‰±ã†ãŸã‚ã®ã®ã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®å…¥ã£ãŸã‚¯ãƒ¬ãƒ¼ãƒˆ - <a href="https://crates.io/crates/stdweb" class="autolink" rel="nofollow noopener" target="_blank">https://crates.io/crates/stdweb</a>
</li>
<li>cargo-web - stdweb ã‚’ä½¿ã£ãŸ Rust ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ« -  <a href="https://crates.io/crates/cargo-web" class="autolink" rel="nofollow noopener" target="_blank">https://crates.io/crates/cargo-web</a>
</li>
</ul>

<h3>
<span id="wasm-bindgen-ç³»çµ±" class="fragment"></span><a href="#wasm-bindgen-%E7%B3%BB%E7%B5%B1"><i class="fa fa-link"></i></a>wasm-bindgen ç³»çµ±</h3>

<ul>
<li><a href="https://rustwasm.github.io" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io</a></li>
<li>Mozilla è‚ã„ã‚Šã® Rust ã‚’ Web ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ã‹ã™ãŸã‚ã®ãƒ„ãƒ¼ãƒ«</li>
<li>emscripten ç³»åˆ—ã‚ˆã‚Šã‚‚æ–°ã—ã„ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ </li>
<li>JavaScript ã‹ã‚‰ Rust ã‚’å‘¼ã³å‡ºã™ã®ãŒä¸»ãªä½¿ã„æ–¹</li>
<li>ä»Šæ—¥è©±ã™ã®ã¯ã“ã‚Œ</li>
</ul>

<h4>
<span id="ä¸»ãªç™»å ´äººç‰©-1" class="fragment"></span><a href="#%E4%B8%BB%E3%81%AA%E7%99%BB%E5%A0%B4%E4%BA%BA%E7%89%A9-1"><i class="fa fa-link"></i></a>ä¸»ãªç™»å ´äººç‰©</h4>

<ul>
<li>wasm-bindgen - åŸºæœ¬çš„ãªå‹ã®ãªã©ãŒå…¥ã£ãŸã‚¯ãƒ¬ãƒ¼ãƒˆ - </li>
<li>js-sys - Rust ã‹ã‚‰ JavaScript ã®å€¤ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚¯ãƒ¬ãƒ¼ãƒˆ</li>
<li>web-sys - Rust ã‹ã‚‰ DOM ã¨ã‹ã‚’å©ããŸã‚ã®ã‚¯ãƒ¬ãƒ¼ãƒˆ</li>
<li>wasm-bindgen-futures - Rust ã® Future ã¨ JavaScript ã® Promise ã®å‹ã‚’ç›¸äº’å¤‰æ›ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ¬ãƒ¼ãƒˆ</li>
<li>wasm-bindgen-cli - wasm-bindgen ã‚„ js-sys ã‚„ web-sys ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ç”Ÿæˆã—ãŸ wasm ãƒ•ã‚¡ã‚¤ãƒ«ã« Rust ã¨ JS ã® FFI ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’è¿½åŠ ã™ã‚‹ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«</li>
<li>wasm-pack - wasm-bindgen ã‚’ä½¿ã£ãŸ Rust ã‚³ãƒ¼ãƒ‰ã‚’ npm ã® package.json ã‹ã‚‰å‘¼ã¶ãŸã‚ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã™ã‚‹ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«</li>
</ul>

<h2>
<span id="ãŠãŠã¾ã‹ãªæ­´å²" class="fragment"></span><a href="#%E3%81%8A%E3%81%8A%E3%81%BE%E3%81%8B%E3%81%AA%E6%AD%B4%E5%8F%B2"><i class="fa fa-link"></i></a>ãŠãŠã¾ã‹ãªæ­´å²</h2>

<ul>
<li>2000å¹´ä»£åˆé ­: Java ã‚¢ãƒ—ãƒ¬ãƒƒãƒˆã€Slackwave Flash å…¨ç››æœŸ</li>
<li>2005å¹´: GoogleMap ã€ Ajax ã®ç™»å ´</li>
<li>2007å¹´: MS ãŒ Silverlight ã‚’ç™ºè¡¨</li>
<li>2010å¹´: emscripten ãŒç™»å ´ã— C/C++ ã‚³ãƒ¼ãƒ‰ã‚’ JavaScript ã«å¤‰æ›ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹</li>
<li>2011å¹´: Google ãŒ NaCl , PNaCl ã‚’ç™ºè¡¨</li>
<li>2013å¹´: Mozilla ãŒ asm.js ã‚’ç™ºè¡¨</li>
<li>2015å¹´: Mozilla ã‚„ Google ãŒ asm.js ã‚’ã‚ˆã‚Šä¸€èˆ¬åŒ–ã—ãŸ wasm ã‚’ç™ºè¡¨</li>
<li>2017å¹´: stdweb</li>
<li>2018å¹´: wasm-bindgen</li>
</ul>

<h2>
<span id="wasm-bindgen-cli-ã¨-wasm-pack-ã®é•ã„" class="fragment"></span><a href="#wasm-bindgen-cli-%E3%81%A8-wasm-pack-%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>wasm-bindgen-cli ã¨ wasm-pack ã®é•ã„</h2>

<ul>
<li>wasm-bindgen-cli ã¯ wasm ã¨ JavaScript ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã¨ TypeScript ã®å‹å®šç¾©ã‚’å‡ºåŠ›ã—ã¦ãã‚Œã‚‹</li>
<li>wasm-pack ã¯å†…éƒ¨ã§ wasm-bindgen-cli ã‚’ä½¿ã„ã€â†‘ã«åŠ ãˆã¦ npm ã«å…¬é–‹ã™ã‚‹ãŸã‚ã® package.json ã‚‚å‡ºåŠ›ã™ã‚‹</li>
</ul>

<h3>
<span id="wasm-bindgen-cli-ã®ç”Ÿæˆç‰©" class="fragment"></span><a href="#wasm-bindgen-cli-%E3%81%AE%E7%94%9F%E6%88%90%E7%89%A9"><i class="fa fa-link"></i></a>wasm-bindgen-cli ã®ç”Ÿæˆç‰©</h3>

<ul>
<li><a href="https://rustwasm.github.io/wasm-bindgen/whirlwind-tour/basic-usage.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/wasm-bindgen/whirlwind-tour/basic-usage.html</a></li>
</ul>

<p>ã“ã‚Œã‚’</p>

<div class="code-frame" data-lang="toml">
<div class="code-lang"><span class="bold">Cargo.toml</span></div>
<div class="highlight"><pre><span class="nn">[package]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"iso-rust3"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.1.0"</span>
<span class="py">authors</span> <span class="p">=</span> <span class="p">[</span><span class="s">"Legokichi Duckscallion &lt;legokichi@gmail.com&gt;"</span><span class="p">]</span>
<span class="py">edition</span> <span class="p">=</span> <span class="s">"2018"</span>

<span class="nn">[lib]</span>
<span class="py">crate-type</span> <span class="p">=</span> <span class="nn">["cdylib"]</span>

<span class="nn">[dependencies]</span>
<span class="py">futures</span> <span class="p">=</span> <span class="s">"0.1"</span>
<span class="py">serde</span> <span class="p">=</span> <span class="s">"1.0"</span>
<span class="py">serde_json</span> <span class="p">=</span> <span class="s">"1.0"</span>
<span class="py">serde_derive</span> <span class="p">=</span> <span class="s">"1.0"</span>
<span class="nn">wasm-bindgen</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.2"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="p">[</span> <span class="s">"serde-serialize"</span> <span class="p">]</span> <span class="p">}</span>
<span class="py">wasm-bindgen-futures</span> <span class="p">=</span> <span class="s">"0.3"</span>
<span class="py">js-sys</span> <span class="p">=</span> <span class="s">"0.3"</span>

<span class="nn">[dependencies.web-sys]</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.3"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="rust">
<div class="code-lang"><span class="bold">src/main.rs</span></div>
<div class="highlight"><pre><span class="k">extern</span> <span class="n">crate</span> <span class="n">wasm_bindgen</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">wasm_bindgen</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="nd">#[wasm_bindgen]</span>
<span class="k">extern</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">alert</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">#[wasm_bindgen]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">greet</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">alert</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>

<p>ã“ã†ã—ã¦</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre><span class="gp">$</span><span class="w"> </span>rustup target add wasm32-unknown-unknown
<span class="gp">$</span><span class="w"> </span>cargo <span class="nb">install </span>wasm-bindgen-cli
<span class="gp">$</span><span class="w"> </span>cargo build <span class="nt">--target</span> wasm32-unknown-unknown
<span class="gp">$</span><span class="w"> </span>wasm-bindgen target/wasm32-unknown-unknown/debug/iso_rust3.wasm <span class="nt">--out-dir</span> ./wasm
<span class="gp">$</span><span class="w"> </span>tree ./wasm
<span class="go">wasm
â”œâ”€â”€ iso_rust3_bg.d.ts
â”œâ”€â”€ iso_rust3_bg.wasm
â”œâ”€â”€ iso_rust3.d.ts
â””â”€â”€ iso_rust3.js
</span></pre></div></div>

<p>ã“ã†ãªã‚‹</p>

<div class="code-frame" data-lang="js">
<div class="code-lang"><span class="bold">iso_rust3.js</span></div>
<div class="highlight"><pre><span class="cm">/* tslint:disable */</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">wasm</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./iso_rust3_bg</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">lTextDecoder</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">TextDecoder</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span> <span class="p">?</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">util</span><span class="dl">'</span><span class="p">).</span><span class="nx">TextDecoder</span> <span class="p">:</span> <span class="nx">TextDecoder</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">cachedTextDecoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">lTextDecoder</span><span class="p">(</span><span class="dl">'</span><span class="s1">utf-8</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">cachegetUint8Memory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">getUint8Memory</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cachegetUint8Memory</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">cachegetUint8Memory</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">!==</span> <span class="nx">wasm</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cachegetUint8Memory</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">wasm</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">cachegetUint8Memory</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getStringFromWasm</span><span class="p">(</span><span class="nx">ptr</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cachedTextDecoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">getUint8Memory</span><span class="p">().</span><span class="nx">subarray</span><span class="p">(</span><span class="nx">ptr</span><span class="p">,</span> <span class="nx">ptr</span> <span class="o">+</span> <span class="nx">len</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">__wbg_alert_d4ac2591f07b50f4</span><span class="p">(</span><span class="nx">arg0</span><span class="p">,</span> <span class="nx">arg1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">varg0</span> <span class="o">=</span> <span class="nx">getStringFromWasm</span><span class="p">(</span><span class="nx">arg0</span><span class="p">,</span> <span class="nx">arg1</span><span class="p">);</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">varg0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/**
* @returns {void}
*/</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">greet</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">wasm</span><span class="p">.</span><span class="nx">greet</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>

<p>â†‘ã¯ js-sys ã‚„ web-sys ã‚’ä»‹ã—ã¦ä½¿ã£ãŸ JavaScript å´ã® API ã‚’å‘¼ã¶ãŸã‚ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ãŒã„ã‚ã„ã‚è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã€‚<br>
ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯ JavaScript ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ wasm ã®ä¸–ç•Œã®ãƒ¡ãƒ¢ãƒªã®ãƒ’ãƒ¼ãƒ—ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã—ã¦ã€ Rust ãŒèª­ã‚ã‚‹å½¢ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿ã€ãã®ãƒã‚¤ãƒ³ã‚¿ã‚’ Rust ã®é–¢æ•°ã«æ¸¡ã—ã¦ã„ã‚‹ã€‚<br>
ã‚ˆã‚Šè¤‡é›‘ãªã“ã¨ã‚’ã™ã‚‹ã¨ã‚ˆã‚Šå¤šãã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚</p>

<div class="code-frame" data-lang="typescript">
<div class="code-lang"><span class="bold">iso_rust3.d.ts</span></div>
<div class="highlight"><pre><span class="cm">/* tslint:disable */</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">greet</span><span class="p">():</span> <span class="k">void</span><span class="p">;</span>
</pre></div>
</div>

<div class="code-frame" data-lang="typescript">
<div class="code-lang"><span class="bold">iso_rust3_bg.d.ts</span></div>
<div class="highlight"><pre><span class="cm">/* tslint:disable */</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">memory</span><span class="p">:</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Memory</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">greet</span><span class="p">():</span> <span class="k">void</span><span class="p">;</span>
</pre></div>
</div>

<p>ã“ã‚Œã‚‰ã®ç”Ÿæˆç‰©ã¯ JavaScript ã‹ã‚‰ ESModule ã‚’ä½¿ã£ã¦ã“ã®ã‚ˆã†ã«å‘¼ã¶ã“ã¨ãŒã§ã„ã‚‹</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="k">import</span><span class="p">(</span><span class="dl">"</span><span class="s2">./wasm</span><span class="dl">"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">iso_rust3</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">iso_rust3</span><span class="p">.</span><span class="nx">greet</span><span class="p">(</span><span class="dl">"</span><span class="s2">World!</span><span class="dl">"</span><span class="p">);</span>
<span class="p">});</span>
</pre></div></div>

<h3>
<span id="wasm-pack-ã®ç”Ÿæˆç‰©" class="fragment"></span><a href="#wasm-pack-%E3%81%AE%E7%94%9F%E6%88%90%E7%89%A9"><i class="fa fa-link"></i></a>wasm-pack ã®ç”Ÿæˆç‰©</h3>

<div class="code-frame" data-lang="console"><div class="highlight"><pre><span class="gp">$</span><span class="w"> </span>rustup target add wasm32-unknown-unknown
<span class="gp">$</span><span class="w"> </span>curl https://rustwasm.github.io/wasm-pack/installer/init.sh <span class="nt">-sSf</span> | sh
<span class="gp">$</span><span class="w"> </span>wasm-pack build <span class="nt">--dev</span>
<span class="gp">$</span><span class="w"> </span>wasm-pack pack
<span class="gp">$</span><span class="w"> </span>pkg
<span class="go">â”œâ”€â”€ iso-rust3-0.1.0.tgz
â”œâ”€â”€ iso_rust3_bg.d.ts
â”œâ”€â”€ iso_rust3_bg.wasm
â”œâ”€â”€ iso_rust3.d.ts
â”œâ”€â”€ iso_rust3.js
â””â”€â”€ package.json
</span></pre></div></div>

<p>package.json ä»¥å¤–ã¯åŒã˜</p>

<div class="code-frame" data-lang="json"><div class="highlight"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iso-rust3"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"collaborators"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"Legokichi Duckscallion &lt;legokichi@gmail.com&gt;"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.1.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"files"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"iso_rust3_bg.wasm"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"iso_rust3.js"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"iso_rust3.d.ts"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"module"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iso_rust3.js"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"types"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iso_rust3.d.ts"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sideEffects"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></div></div>

<p><code>wasm-pack pack</code> ã¯ iso-rust3-0.1.0.tgz ã‚’ç”Ÿæˆã™ã‚‹ã€‚ <code>npm pack</code> ç›¸å½“ã€‚</p>

<h2>
<span id="ãŠã¾ã‘-js-sys-ã¨-web-sys" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91-js-sys-%E3%81%A8-web-sys"><i class="fa fa-link"></i></a>ãŠã¾ã‘: js-sys ã¨ web-sys</h2>

<p>js-sys ã¨ web-sys ã‚’ä½¿ã†ã¨ã€ä¾‹ãˆã° WebAudioAPI ã® ScriptProcessor ãªã©ã‚‚ä½¿ãˆã‚‹ã€‚<br>
ã“ã“ã§ FFT ã¨ã‹ã‚’ Rust ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚Œã°å¬‰ã—ã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚<br>
ãŸã ã—ã€ã“ã®ã‚ˆã†ãªç…©é›‘ã§ unwrap ã¾ã¿ã‚Œã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããƒãƒ¡ã«ãªã‚‹ã€‚</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre><span class="k">extern</span> <span class="n">crate</span> <span class="n">wasm_bindgen</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">wasm_bindgen</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">futures</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">wasm_bindgen_futures</span><span class="p">::{</span><span class="n">JsFuture</span><span class="p">,</span> <span class="n">future_to_promise</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">wasm_bindgen</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">wasm_bindgen</span><span class="p">::</span><span class="n">JsCast</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">js_sys</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">web_sys</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">serde_derive</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="nd">#[wasm_bindgen]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="k">let</span> <span class="n">window</span> <span class="o">=</span> <span class="nf">window</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">document</span> <span class="o">=</span> <span class="n">window</span><span class="nf">.document</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">media_devices</span> <span class="o">=</span> <span class="n">window</span><span class="nf">.navigator</span><span class="p">()</span><span class="nf">.media_devices</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="nd">#[derive(Serialize)]</span>
    <span class="k">struct</span> <span class="n">Constraints</span> <span class="p">{</span>
        <span class="n">audio</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">video</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">let</span> <span class="n">constraints</span> <span class="o">=</span> <span class="nn">JsValue</span><span class="p">::</span><span class="nf">from_serde</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Constraints</span><span class="p">{</span><span class="n">audio</span><span class="p">:</span> <span class="k">true</span><span class="p">,</span> <span class="n">video</span><span class="p">:</span> <span class="k">false</span><span class="p">})</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">prm</span> <span class="o">=</span> <span class="n">media_devices</span><span class="nf">.get_user_media_with_constraints</span><span class="p">(</span><span class="o">&lt;</span><span class="n">MediaStreamConstraints</span> <span class="k">as</span> <span class="n">JsCast</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">unchecked_from_js_ref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">constraints</span><span class="p">))</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="n">cb</span> <span class="o">=</span> <span class="nn">Closure</span><span class="p">::</span><span class="nf">wrap</span><span class="p">(</span><span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">move</span> <span class="p">|</span><span class="n">media_stream</span><span class="p">:</span> <span class="n">JsValue</span><span class="p">|{</span>
            <span class="nn">console</span><span class="p">::</span><span class="k">log</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">js_sys</span><span class="p">::</span><span class="nn">Array</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"Hello, ğŸ’©!"</span><span class="p">)));</span>
            <span class="k">let</span> <span class="n">src</span> <span class="o">=</span> <span class="nn">Url</span><span class="p">::</span><span class="nf">create_object_url_with_source</span><span class="p">(</span><span class="o">&amp;</span><span class="n">media_stream</span><span class="nf">.into</span><span class="p">())</span><span class="nf">.unwrap</span><span class="p">();</span>
            <span class="k">let</span> <span class="n">audio</span> <span class="o">=</span> <span class="nn">HtmlAudioElement</span><span class="p">::</span><span class="nf">new_with_src</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>
            <span class="p">(</span><span class="n">audio</span><span class="nf">.as_ref</span><span class="p">()</span> <span class="k">as</span> <span class="o">&amp;</span><span class="n">HtmlMediaElement</span><span class="p">)</span><span class="nf">.set_autoplay</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="p">(</span><span class="n">audio</span><span class="nf">.as_ref</span><span class="p">()</span> <span class="k">as</span> <span class="o">&amp;</span><span class="n">HtmlMediaElement</span><span class="p">)</span><span class="nf">.set_controls</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="k">let</span> <span class="n">cb</span> <span class="o">=</span> <span class="nn">Closure</span><span class="p">::</span><span class="nf">wrap</span><span class="p">(</span><span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">move</span> <span class="p">|</span><span class="n">ev</span><span class="p">|{</span>
                <span class="nn">console</span><span class="p">::</span><span class="k">log</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">js_sys</span><span class="p">::</span><span class="nn">Array</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"Hello, ğŸ’©!"</span><span class="p">)));</span>
                <span class="k">let</span> <span class="n">actx</span> <span class="o">=</span> <span class="nn">AudioContext</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
                <span class="k">let</span> <span class="n">processor</span> <span class="o">=</span> <span class="p">(</span><span class="n">actx</span><span class="nf">.as_ref</span><span class="p">()</span> <span class="k">as</span> <span class="o">&amp;</span><span class="n">BaseAudioContext</span><span class="p">)</span><span class="nf">.create_script_processor</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
                <span class="k">let</span> <span class="n">cb</span> <span class="o">=</span> <span class="nn">Closure</span><span class="p">::</span><span class="nf">wrap</span><span class="p">(</span><span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">move</span> <span class="p">|</span><span class="n">ev</span><span class="p">:</span> <span class="n">Event</span><span class="p">|{</span>
                    <span class="c">// let abuf = (ev.as_ref() as &amp;AudioProcessingEvent).input_buffer().unwrap();</span>
                    <span class="c">// ã‚„ã£ã¦ã‚‰ã‚Œã‚“ï¼</span>
                    <span class="nn">console</span><span class="p">::</span><span class="k">log</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">js_sys</span><span class="p">::</span><span class="nn">Array</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">JsValue</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"Hello, ğŸ’©!"</span><span class="p">)));</span>
                <span class="p">})</span> <span class="k">as</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">FnMut</span><span class="p">(</span><span class="n">Event</span><span class="p">)</span><span class="o">&gt;</span><span class="p">);</span>
                <span class="n">processor</span><span class="nf">.set_onaudioprocess</span><span class="p">(</span><span class="nf">Some</span><span class="p">(</span><span class="n">cb</span><span class="nf">.as_ref</span><span class="p">()</span><span class="nf">.unchecked_ref</span><span class="p">()));</span>
                <span class="p">(</span><span class="n">processor</span><span class="nf">.as_ref</span><span class="p">()</span> <span class="k">as</span> <span class="o">&amp;</span><span class="n">AudioNode</span><span class="p">)</span><span class="nf">.connect_with_audio_node</span><span class="p">((</span><span class="n">actx</span><span class="nf">.as_ref</span><span class="p">()</span> <span class="k">as</span> <span class="o">&amp;</span><span class="n">BaseAudioContext</span><span class="p">)</span><span class="nf">.destination</span><span class="p">()</span><span class="nf">.as_ref</span><span class="p">());</span>
                <span class="n">cb</span><span class="nf">.forget</span><span class="p">();</span>
            <span class="p">})</span> <span class="k">as</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">FnMut</span><span class="p">(</span><span class="n">Event</span><span class="p">)</span><span class="o">&gt;</span><span class="p">);</span>
            <span class="p">(</span><span class="n">audio</span><span class="nf">.as_ref</span><span class="p">()</span> <span class="k">as</span> <span class="o">&amp;</span><span class="n">EventTarget</span><span class="p">)</span><span class="nf">.add_event_listener_with_callback</span><span class="p">(</span><span class="s">"loadedmetadata"</span><span class="p">,</span> <span class="n">cb</span><span class="nf">.as_ref</span><span class="p">()</span><span class="nf">.unchecked_ref</span><span class="p">())</span><span class="nf">.unwrap</span><span class="p">();</span>
            <span class="p">(</span><span class="n">document</span><span class="nf">.body</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.as_ref</span><span class="p">()</span> <span class="k">as</span> <span class="o">&amp;</span><span class="n">Node</span><span class="p">)</span><span class="nf">.append_child</span><span class="p">(</span><span class="n">audio</span><span class="nf">.as_ref</span><span class="p">())</span><span class="nf">.unwrap</span><span class="p">();</span>
            <span class="n">cb</span><span class="nf">.forget</span><span class="p">();</span>
        <span class="p">})</span> <span class="k">as</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">FnMut</span><span class="p">(</span><span class="n">JsValue</span><span class="p">)</span><span class="o">&gt;</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">prm</span> <span class="o">=</span> <span class="n">prm</span><span class="nf">.then</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">);</span>
        <span class="n">cb</span><span class="nf">.forget</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<p>JSã®API ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã²ã¨ã¤æ›¸ãã«ã—ã¦ã‚‚ wasm_bindgen ã® Closure ã‚’ä½¿ã£ã¦</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre><span class="k">let</span> <span class="n">cb</span> <span class="o">=</span> <span class="nn">Closure</span><span class="p">::</span><span class="nf">wrap</span><span class="p">(</span><span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">move</span> <span class="p">|</span><span class="n">ev</span><span class="p">|{</span>
    <span class="c">// hogehoge</span>
    <span class="n">cb</span><span class="nf">.forget</span><span class="p">();</span>
<span class="p">})</span> <span class="k">as</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nf">FnMut</span><span class="p">(</span><span class="n">Event</span><span class="p">)</span><span class="o">&gt;</span><span class="p">);</span>
</pre></div></div>

<p>ã®ã‚ˆã†ã«ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®GCã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚‚è‡ªåˆ†ã§æŒ‡å®šã›ã­ã°ãªã‚‰ãšé¢å€’ãã•ã„ã€‚(<a href="https://rustwasm.github.io/wasm-bindgen/examples/closures.html" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/wasm-bindgen/examples/closures.html</a>)<br>
ãã—ã¦ IF ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯æ•°ç™¾è¡Œã«åŠã¶ï¼ˆãã‚Œã§ã‚‚ emscripten ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚ˆã‚Šã¯é¥ã‹ã«å°‘ãªã„ãŒï¼‰</p>

<p>ã¾ãŸç¾çŠ¶ web-sys ã®ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« features ã‚’ WebIDL æ¯ã«æ›¸ã„ã¦ã„ã‹ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼ˆãã®ã†ã¡æ”¹å–„ã•ã‚Œã‚‹ã‚‰ã—ã„</p>

<div class="code-frame" data-lang="toml">
<div class="code-lang"><span class="bold">Cargo.toml</span></div>
<div class="highlight"><pre><span class="nn">[package]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"iso-rust3"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.1.0"</span>
<span class="py">authors</span> <span class="p">=</span> <span class="p">[</span><span class="s">"Legokichi Duckscallion &lt;legokichi@gmail.com&gt;"</span><span class="p">]</span>
<span class="py">edition</span> <span class="p">=</span> <span class="s">"2018"</span>

<span class="nn">[lib]</span>
<span class="py">crate-type</span> <span class="p">=</span> <span class="nn">["cdylib"]</span>

<span class="nn">[dependencies]</span>
<span class="py">futures</span> <span class="p">=</span> <span class="s">"0.1"</span>
<span class="py">serde</span> <span class="p">=</span> <span class="s">"1.0"</span>
<span class="py">serde_json</span> <span class="p">=</span> <span class="s">"1.0"</span>
<span class="py">serde_derive</span> <span class="p">=</span> <span class="s">"1.0"</span>
<span class="nn">wasm-bindgen</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.2"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="p">[</span> <span class="s">"serde-serialize"</span> <span class="p">]</span> <span class="p">}</span>
<span class="py">wasm-bindgen-futures</span> <span class="p">=</span> <span class="s">"0.3"</span>
<span class="py">js-sys</span> <span class="p">=</span> <span class="s">"0.3"</span>

<span class="nn">[dependencies.web-sys]</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.3"</span>
<span class="py">features</span> <span class="p">=</span> <span class="p">[</span>
    <span class="err">'AbortController'</span><span class="p">,</span>
    <span class="err">'AbortSignal'</span><span class="p">,</span>
    <span class="err">'AddEventListenerOptions'</span><span class="p">,</span>
    <span class="err">...</span>
    <span class="err">'XmlHttpRequestUpload'</span><span class="p">,</span>
    <span class="err">'XmlSerializer'</span><span class="p">,</span>
    <span class="err">'XsltProcessor'</span><span class="p">,</span>
    <span class="err">'console'</span><span class="p">,</span>
    <span class="err">'css'</span>
<span class="p">]</span>
</pre></div>
</div>

<h2>
<span id="æƒ…å ±æº" class="fragment"></span><a href="#%E6%83%85%E5%A0%B1%E6%BA%90"><i class="fa fa-link"></i></a>æƒ…å ±æº</h2>

<ul>
<li>
<a href="https://rustwasm.github.io/" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/</a> - å…¬å¼ãƒ–ãƒ­ã‚°</li>
<li>
<a href="https://rustwasm.github.io/book/" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/book/</a> - å…¥é–€è€…å‘ã‘ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</li>
<li>
<a href="https://rustwasm.github.io/wasm-bindgen/" class="autolink" rel="nofollow noopener" target="_blank">https://rustwasm.github.io/wasm-bindgen/</a> - ç¶²ç¾…çš„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</li>
<li>
<a href="https://github.com/rustwasm/awesome-rust-and-webassembly" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/rustwasm/awesome-rust-and-webassembly</a> - Awesome</li>
<li>
<a href="https://github.com/rustwasm/rfcs" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/rustwasm/rfcs</a> - rfcs</li>
</ul>
