<p>getUserMedia した MediaStream を MediaRecorder で WebM Stream　にしてから MediaSource に食わせて 動画再生する。</p>

<p>Chrome60 以降ならば止まらずに連続再生できるようだ。</p>

<p>demo: <a href="https://jsfiddle.net/nthyfgvs/" class="autolink" rel="nofollow noopener" target="_blank">https://jsfiddle.net/nthyfgvs/</a></p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre>
<span class="kd">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="nx">main</span><span class="p">(){</span>
  <span class="kd">const</span> <span class="nx">logging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">tasks</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="k">void</span> <span class="mi">0</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">devices</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">enumerateDevices</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">devices</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="p">?</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span><span class="na">video</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">audio</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span> <span class="p">:</span>
                       <span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="p">?</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span><span class="na">video</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">audio</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">))</span> <span class="p">:</span>
                       <span class="nb">navigator</span><span class="p">.</span><span class="nx">webkitGetUserMedia</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="p">?</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">webkitGetUserMedia</span><span class="p">({</span><span class="na">video</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">audio</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">))</span> <span class="p">:</span>
                       <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">cannot use usermedia</span><span class="dl">"</span><span class="p">));</span>


  <span class="k">if</span><span class="p">(</span><span class="nx">logging</span><span class="p">){</span>
    <span class="nx">stream</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">active</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">stream</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">inactive</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">stream</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">addtrack</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">stream</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">removetrack</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">rec</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MediaRecorder</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="p">{</span><span class="na">mimeType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">video/webm; codecs="opus,vp8"</span><span class="dl">'</span><span class="p">});</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">logging</span><span class="p">){</span>
    <span class="nx">rec</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">dataavailable</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">rec</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">pause</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">rec</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">resume</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">rec</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">rec</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">stop</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">rec</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">ev</span><span class="p">);</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MediaSource</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">logging</span><span class="p">){</span>
    <span class="nx">ms</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">sourceopen</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">ms</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">sourceended</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">ms</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">sourceclose</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">ms</span><span class="p">.</span><span class="nx">sourceBuffers</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">addsourcebuffer</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">ms</span><span class="p">.</span><span class="nx">sourceBuffers</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">removesourcebuffer</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">video</span><span class="dl">"</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">logging</span><span class="p">){</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">loadstart</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">progress</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">loadedmetadata</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">loadeddata</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">canplay</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">canplaythrough</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">playing</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">waiting</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">seeking</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">seeked</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">ended</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">emptied</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">stalled</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">timeupdate</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span> <span class="c1">// annoying</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">durationchange</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">ratechange</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">play</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">pause</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">ev</span><span class="p">);</span> <span class="p">});</span>
  <span class="p">}</span>
  <span class="nx">video</span><span class="p">.</span><span class="nx">volume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">video</span><span class="p">.</span><span class="nx">controls</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">video</span><span class="p">.</span><span class="nx">autoplay</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">video</span><span class="p">);</span>

  <span class="k">yield</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">ms</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">sourceopen</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(),</span> <span class="p">{</span><span class="na">once</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="c1">//video.srcObject = ms;</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">ms</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">sb</span> <span class="o">=</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">addSourceBuffer</span><span class="p">(</span><span class="nx">rec</span><span class="p">.</span><span class="nx">mimeType</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">logging</span><span class="p">){</span>
    <span class="nx">sb</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">updatestart</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span> <span class="c1">// annoying</span>
    <span class="nx">sb</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">update</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span> <span class="c1">// annoying</span>
    <span class="nx">sb</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">updateend</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span> <span class="c1">// annoying</span>
    <span class="nx">sb</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">ev</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">sb</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">abort</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">stop</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="nx">stop</span><span class="p">(){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">stopping</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">sb</span><span class="p">.</span><span class="nx">updating</span><span class="p">){</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">open</span><span class="dl">"</span><span class="p">){</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">endOfStream</span><span class="p">();</span> <span class="p">}</span>
    <span class="nx">rec</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="nx">stream</span><span class="p">.</span><span class="nx">getTracks</span><span class="p">().</span><span class="nx">map</span><span class="p">((</span><span class="nx">track</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">track</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span> <span class="p">});</span>
    <span class="k">yield</span> <span class="nx">video</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">button</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">button</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">stop</span><span class="dl">"</span><span class="p">;</span>
  <span class="nx">button</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">button</span><span class="p">);</span>
    <span class="nx">tasks</span> <span class="o">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">stop</span><span class="p">);</span>
  <span class="p">},</span> <span class="p">{</span><span class="na">once</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">button</span><span class="p">);</span>

  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">rec</span><span class="p">.</span><span class="nx">ondataavailable</span> <span class="o">=</span> <span class="p">({</span><span class="nx">data</span><span class="p">})</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">tasks</span> <span class="o">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">async</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="dl">""</span><span class="o">+</span><span class="nx">i</span><span class="p">);</span>

      <span class="k">try</span><span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">logging</span><span class="p">){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">dataavailable</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">size:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span> <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">empty recorder data</span><span class="dl">"</span><span class="p">);</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">empty recorder data</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">const</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

        <span class="k">yield</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
          <span class="nx">sb</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">updateend</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(),</span> <span class="p">{</span><span class="na">once</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="nx">sb</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">ev</span><span class="p">),</span> <span class="p">{</span><span class="na">once</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="nx">sb</span><span class="p">.</span><span class="nx">appendBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">logging</span><span class="p">){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">timestampOffset</span><span class="dl">"</span><span class="p">,</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">timestampOffset</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">appendWindowStart</span><span class="dl">"</span><span class="p">,</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">appendWindowStart</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">appendWindowEnd</span><span class="dl">"</span><span class="p">,</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">appendWindowEnd</span><span class="p">);</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">sb</span><span class="p">.</span><span class="nx">buffered</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">buffered</span><span class="dl">"</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">buffered</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">buffered</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">video</span><span class="p">.</span><span class="nx">seekable</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">seekable</span><span class="dl">"</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">video</span><span class="p">.</span><span class="nx">seekable</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">video</span><span class="p">.</span><span class="nx">seekable</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">webkitAudioDecodedByteCount</span><span class="dl">"</span><span class="p">,</span> <span class="nx">video</span><span class="p">.</span><span class="nx">webkitAudioDecodedByteCount</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">webkitVideoDecodedByteCount</span><span class="dl">"</span><span class="p">,</span> <span class="nx">video</span><span class="p">.</span><span class="nx">webkitVideoDecodedByteCount</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">webkitDecodedFrameCount</span><span class="dl">"</span><span class="p">,</span> <span class="nx">video</span><span class="p">.</span><span class="nx">webkitDecodedFrameCount</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">webkitDroppedFrameCount</span><span class="dl">"</span><span class="p">,</span> <span class="nx">video</span><span class="p">.</span><span class="nx">webkitDroppedFrameCount</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">video</span><span class="p">.</span><span class="nx">buffered</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">MSE buffered has a gap!</span><span class="dl">"</span><span class="p">);</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">MSE buffered has a gap!</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">yield</span> <span class="nx">stop</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">groupEnd</span><span class="p">(</span><span class="dl">""</span><span class="o">+</span><span class="nx">i</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">groupEnd</span><span class="p">(</span><span class="dl">""</span><span class="o">+</span><span class="nx">i</span><span class="p">);</span>
      <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}));</span>
  <span class="p">};</span>

  <span class="nx">rec</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">);</span>
<span class="p">});</span>



<span class="kd">function</span> <span class="nx">sleep</span><span class="p">(</span><span class="nx">ms</span><span class="p">){</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span>
    <span class="nx">setTimeout</span><span class="p">((()</span><span class="o">=&gt;</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">ms</span><span class="p">)),</span> <span class="nx">ms</span><span class="p">));</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">blob</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="kd">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
    <span class="nx">reader</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">loadend</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">reader</span><span class="p">.</span><span class="nx">result</span><span class="p">),</span> <span class="p">{</span><span class="na">once</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">reader</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">reader</span><span class="p">.</span><span class="nx">error</span><span class="p">),</span> <span class="p">{</span><span class="na">once</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="k">async</span><span class="p">(</span><span class="nx">generatorFunc</span><span class="p">){</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">generator</span> <span class="o">=</span> <span class="nx">generatorFunc</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">next</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">generator</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">done</span><span class="p">){</span> <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Promise</span><span class="p">){</span> <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span> <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">();</span>
</pre></div></div>

<h2>
<span id="related-issues" class="fragment"></span><a href="#related-issues"><i class="fa fa-link"></i></a>related issues</h2>

<ul>
<li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=606000" class="autolink" rel="nofollow noopener" target="_blank">https://bugs.chromium.org/p/chromium/issues/detail?id=606000</a></li>
<li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=678269" class="autolink" rel="nofollow noopener" target="_blank">https://bugs.chromium.org/p/chromium/issues/detail?id=678269</a></li>
<li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=688490" class="autolink" rel="nofollow noopener" target="_blank">https://bugs.chromium.org/p/chromium/issues/detail?id=688490</a></li>
<li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=711829" class="autolink" rel="nofollow noopener" target="_blank">https://bugs.chromium.org/p/chromium/issues/detail?id=711829</a></li>
</ul>
