
<h2>
<span id="モナドを定義する" class="fragment"></span><a href="#%E3%83%A2%E3%83%8A%E3%83%89%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>モナドを定義する</h2>

<p>モナドという性質をもつ型は</p>

<ul>
<li>二項演算 <code>&gt;&gt;=</code> (bind) </li>
<li>一項演算 <code>pure</code>
</li>
</ul>

<p>を持ちます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">class</span> <span class="nx">Monad</span><span class="p">{</span>
  <span class="c1">// pure :: a -&gt; m a</span>
  <span class="kd">static</span> <span class="nx">pure</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">abstruct</span><span class="dl">"</span><span class="p">);</span> <span class="p">}</span>
  <span class="c1">// (&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b</span>
  <span class="nx">bind</span><span class="p">(</span><span class="nx">f</span><span class="p">){</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">abstruct</span><span class="dl">"</span><span class="p">);</span> <span class="p">}</span>
  <span class="c1">// bind(f){ return this.constructor.join(this.constructor.map(f(this))); }</span>

  <span class="c1">// join :: m m a -&gt; m a</span>
  <span class="c1">//static join(mma){ return mma.bind((ma)=&gt; ma); }</span>
  <span class="c1">// (&lt;$&gt;) ::  m a -&gt; (a -&gt; b) -&gt; m b</span>
  <span class="c1">//map(f){ return this.bind((a)=&gt; this.constructor.pure(f(a))); }</span>
<span class="p">}</span>
</pre></div></div>

<ul>
<li>余談

<ul>
<li>数学的に厳密なモナドは pure と map と join を持つ。</li>
<li>bind は map と join と pure から導出できる</li>
<li>詳しい話は <a href="https://ja.wikibooks.org/wiki/Haskell/%E5%9C%8F%E8%AB%96" class="autolink" rel="nofollow noopener" target="_blank">https://ja.wikibooks.org/wiki/Haskell/%E5%9C%8F%E8%AB%96</a> や <a href="https://pursuit.purescript.org/packages/purescript-prelude/" class="autolink" rel="nofollow noopener" target="_blank">https://pursuit.purescript.org/packages/purescript-prelude/</a> を見てくだし</li>
</ul>
</li>
</ul>

<h2>
<span id="do-構文を定義する" class="fragment"></span><a href="#do-%E6%A7%8B%E6%96%87%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>do 構文を定義する</h2>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_do</span><span class="p">(</span><span class="nx">M</span><span class="p">,</span> <span class="nx">genfn</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">genfn</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">recur</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
  <span class="kd">function</span> <span class="nx">recur</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">prev</span><span class="p">){</span>
    <span class="kd">const</span> <span class="p">{</span><span class="nx">value</span><span class="p">,</span> <span class="nx">done</span><span class="p">}</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">prev</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">ma</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">M</span> <span class="p">?</span> <span class="nx">value</span> <span class="p">:</span> <span class="nx">M</span><span class="p">.</span><span class="nx">pure</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">ma</span><span class="p">.</span><span class="nx">bind</span><span class="p">((</span><span class="nx">a</span><span class="p">)</span><span class="o">=&gt;</span> <span class="o">!</span><span class="nx">done</span> <span class="p">?</span> <span class="nx">recur</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="p">:</span> <span class="nx">M</span><span class="p">.</span><span class="nx">pure</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<ul>
<li>JS の <code>do</code> は予約語なので <code>_do</code> にしてます</li>
<li>do 構文は、モナディックな型の値 m1, m2, m3 を逐次返す generator を引数にとる</li>
<li>そして <code>ma.bind((a)=&gt; mb.bind((b)=&gt; mc.bind((c)=&gt; Monad.pure(c) )))</code> のように計算をつなげる</li>
<li>_do の第一引数にモナド型のコンストラクタを渡しているのは

<ul>
<li>
<code>const ma = value instanceof M ? value : M.pure(value);</code> のために使っている</li>
<li> <code>return</code> と <code>yield</code> の違いを吸収するために必要</li>
<li>本当は <code>return pure(a)</code> か <code>yield pure(a)</code> が正しい</li>
<li><del>haskell の return にシャレて return a と書けるようにしている</del></li>
<li>
<a href="https://github.com/tj/co" rel="nofollow noopener" target="_blank">co</a> や async-await は <code>await</code> や <code>return</code> で <code>Promise</code> に強制的に包む仕様なので（非同期実行のため）それにあわせた</li>
<li>while ではなく recur してるのも非同期実行されることを意識しているから</li>
</ul>
</li>
</ul>

<h2>
<span id="maybe-モナドを定義する" class="fragment"></span><a href="#maybe-%E3%83%A2%E3%83%8A%E3%83%89%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Maybe モナドを定義する</h2>

<p>Maybe の <code>&gt;&gt;=</code> (bind) の性質は、計算結果が nothing だと計算を打ち切って nothing を返します。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">class</span> <span class="nx">Maybe</span> <span class="kd">extends</span> <span class="nx">Monad</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span> <span class="k">super</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">isJust</span><span class="p">(){</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">isNothing</span><span class="p">(){</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">==</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">bind</span><span class="p">(</span><span class="nx">cont</span><span class="p">){</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">isJust</span><span class="p">()</span> <span class="p">?</span> <span class="nx">cont</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">a</span><span class="p">)</span> <span class="p">:</span> <span class="nx">Maybe</span><span class="p">.</span><span class="nx">nothing</span><span class="p">();</span> <span class="p">}</span>
  <span class="kd">static</span> <span class="nx">pure</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span> <span class="k">return</span> <span class="nx">Maybe</span><span class="p">.</span><span class="nx">just</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="p">}</span>
  <span class="kd">static</span> <span class="nx">just</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Maybe</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="p">}</span>
  <span class="kd">static</span> <span class="nx">nothing</span><span class="p">(){</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Maybe</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span> <span class="p">}</span>
  <span class="nx">toString</span><span class="p">(){</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">isJust</span><span class="p">()</span> <span class="p">?</span> <span class="s2">`Just </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">a</span><span class="p">}</span><span class="s2">`</span> <span class="p">:</span> <span class="s2">`Nothing`</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="maybe-モナドを使ってみる" class="fragment"></span><a href="#maybe-%E3%83%A2%E3%83%8A%E3%83%89%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>Maybe モナドを使ってみる</h2>

<p>すべて just なら成功。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">main</span><span class="p">(){</span>
  <span class="kd">const</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">_do</span><span class="p">(</span><span class="nx">Maybe</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span> <span class="nx">calc</span><span class="p">(){</span>
    <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Maybe</span><span class="p">.</span><span class="nx">just</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Maybe</span><span class="p">.</span><span class="nx">just</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Maybe</span><span class="p">.</span><span class="nx">just</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span>  <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">Just 2</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">main</span><span class="p">();</span>
</pre></div></div>

<p>ひとつでも nothing があれば nothing。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">main</span><span class="p">(){</span>
  <span class="kd">const</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">_do</span><span class="p">(</span><span class="nx">Maybe</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span> <span class="nx">calc</span><span class="p">(){</span>
    <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Maybe</span><span class="p">.</span><span class="nx">just</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Maybe</span><span class="p">.</span><span class="nx">nothing</span><span class="p">();</span> <span class="c1">// なんか処理がうまくいかなかった</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Maybe</span><span class="p">.</span><span class="nx">just</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span>  <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">opt2</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">Nothing</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">main</span><span class="p">();</span>
</pre></div></div>

<p>null 安全なコードが書けた。</p>

<h2>
<span id="either-モナドを定義する" class="fragment"></span><a href="#either-%E3%83%A2%E3%83%8A%E3%83%89%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Either モナドを定義する</h2>

<p>Either モナドの <code>&gt;&gt;=</code> (bind) の性質は、計算結果が left のときは計算を打ち切って left 値を返します。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">class</span> <span class="nx">Either</span> <span class="kd">extends</span> <span class="nx">Monad</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">){</span> <span class="k">super</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">l</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span>  <span class="p">}</span>
  <span class="nx">isLeft</span><span class="p">(){</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">l</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">isRight</span><span class="p">(){</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">bind</span><span class="p">(</span><span class="nx">cont</span><span class="p">){</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">isRight</span><span class="p">()</span> <span class="p">?</span> <span class="nx">cont</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span> <span class="p">:</span> <span class="nx">Either</span><span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">l</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="p">}</span>
  <span class="kd">static</span> <span class="nx">pure</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span> <span class="k">return</span> <span class="nx">Either</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="p">}</span>
  <span class="kd">static</span> <span class="nx">right</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Either</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span> <span class="p">}</span>
  <span class="kd">static</span> <span class="nx">left</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Either</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="p">}</span>
  <span class="nx">toString</span><span class="p">(){</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">isLeft</span><span class="p">()</span> <span class="p">?</span> <span class="s2">`Left </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">l</span><span class="p">}</span><span class="s2">`</span> <span class="p">:</span> <span class="s2">`Right </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">r</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="either-モナドを使ってみる" class="fragment"></span><a href="#either-%E3%83%A2%E3%83%8A%E3%83%89%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>Either モナドを使ってみる</h2>

<p>すべて right なら計算が最後まで続く</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">main</span><span class="p">(){</span>
  <span class="kd">const</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">_do</span><span class="p">(</span><span class="nx">Either</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
    <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Either</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Either</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Either</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span>  <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">Right 2</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">main</span><span class="p">();</span>
</pre></div></div>

<p>途中で処理が失敗(=left)したらそこで計算を打ち切って left を返す</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">main</span><span class="p">(){</span>
  <span class="kd">const</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">_do</span><span class="p">(</span><span class="nx">Either</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
    <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Either</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Either</span><span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="dl">"</span><span class="s2">fail</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// なんか処理が失敗した</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Either</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span>  <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">Left fail</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">main</span><span class="p">();</span>
</pre></div></div>

<p>失敗つき計算を表現できた。うれしい！</p>

<h2>
<span id="promise-モナド" class="fragment"></span><a href="#promise-%E3%83%A2%E3%83%8A%E3%83%89"><i class="fa fa-link"></i></a>Promise モナド</h2>

<p>Promise はJSの実装そのまま使ってみます。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="nb">Promise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bind</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">pure</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">;</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">Monad</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">join</span> <span class="o">=</span> <span class="nx">Monad</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>
</pre></div></div>

<ul>
<li>JS の Promiseはネストできないので <code>map</code> を定義しても <code>then</code> と同じ</li>
<li>JS の Promiseはネストできないので <code>join</code> を定義するのはあまり意味がない 

<ul>
<li>
<code>Promise.resolve(Promise.resolve(1))</code> は <code>Promise.resolve(1)</code> として扱われる</li>
</ul>
</li>
</ul>

<h2>
<span id="promise-モナドを使ってみる" class="fragment"></span><a href="#promise-%E3%83%A2%E3%83%8A%E3%83%89%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>Promise モナドを使ってみる</h2>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">main</span><span class="p">(){</span>
  <span class="kd">const</span> <span class="nx">prm</span> <span class="o">=</span> <span class="nx">_do</span><span class="p">(</span><span class="nb">Promise</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
    <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span>  <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="c1">// JS の Promise はそのイベントループの中作られた Promise 値は次のイベントループまで pending になるため中を見るには then する必要ある</span>
  <span class="nx">prm</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="mi">2</span><span class="p">))</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span>
<span class="p">}</span>
<span class="nx">main</span><span class="p">();</span>
</pre></div></div>

<p>これが、 async-await の実装の基礎です (実際は try-catch も使えるようになっているので少し違う)</p>

<h3>
<span id="try-catch-できる-async-await-の実装" class="fragment"></span><a href="#try-catch-%E3%81%A7%E3%81%8D%E3%82%8B-async-await-%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>try-catch できる async-await の実装</h3>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">function</span> <span class="k">async</span><span class="p">(</span><span class="nx">genfn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="kd">const</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">genfn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">recur</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">recur</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">prev</span><span class="p">,</span> <span class="nx">preverr</span><span class="p">){</span>
      <span class="k">try</span><span class="p">{</span>
        <span class="kd">const</span> <span class="p">{</span><span class="nx">value</span><span class="p">,</span> <span class="nx">done</span><span class="p">}</span> <span class="o">=</span> <span class="nx">preverr</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">?</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">prev</span><span class="p">)</span> <span class="p">:</span> <span class="nx">gen</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">preverr</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">ma</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Promise</span> <span class="p">?</span> <span class="nx">value</span> <span class="p">:</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">ma</span>
          <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">a</span><span class="p">)</span><span class="o">=&gt;</span> <span class="o">!</span><span class="nx">done</span> <span class="p">?</span> <span class="nx">recur</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span> <span class="p">:</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">)</span>
          <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span><span class="o">=&gt;</span> <span class="o">!</span><span class="nx">done</span> <span class="p">?</span> <span class="nx">recur</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">:</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">recur</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</pre></div></div>

<p>do との違いとして</p>

<ul>
<li>generator 関数を promise 値関数に変換するために <code>return (...args)=&gt;{</code> している</li>
<li>generator の実行を try-catch で囲んでいる</li>
<li>err が扱えるように recur が 3 引数になった</li>
<li>
<code>generatir.throw</code> で generator 関数へ <code>throw</code> している</li>
</ul>

<p>などがあります。</p>

<h3>
<span id="async-await-を使う" class="fragment"></span><a href="#async-await-%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>async-await を使う</h3>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">init</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">init</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="nx">init</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span>  <span class="mi">1</span> <span class="o">+</span> <span class="nx">init</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">main</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="mi">2</span> <span class="o">===</span> <span class="nx">c</span><span class="p">))</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span>
</pre></div></div>

<p>main に引数が付きました。</p>

<p>もちろんエラー対策も万全なので</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">init</span><span class="p">){</span>
  <span class="kd">let</span> <span class="nx">a</span><span class="p">;</span>
  <span class="k">try</span><span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">some error</span><span class="dl">"</span><span class="p">);</span> 
    <span class="nx">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">init</span><span class="p">);</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="c1">// catch できる</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">init</span><span class="p">;</span> <span class="c1">// resolve なくてもいける</span>
  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="nx">init</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">b</span><span class="p">;</span>
  <span class="k">try</span><span class="p">{</span>
    <span class="nx">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">some AIO erorr</span><span class="dl">"</span><span class="p">));</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="c1">// reject も catch できる</span>
    <span class="nx">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">c</span> <span class="o">===</span>  <span class="mi">1</span> <span class="o">+</span> <span class="nx">init</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">main</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="mi">2</span> <span class="o">===</span> <span class="nx">c</span><span class="p">))</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span>
</pre></div></div>

<p>のような処理も実行できます</p>

<h3>
<span id="do-と-async-の-diff" class="fragment"></span><a href="#do-%E3%81%A8-async-%E3%81%AE-diff"><i class="fa fa-link"></i></a>do と async の diff</h3>

<p><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fi.gyazo.com%2F0cdb32310ccc94bc962721232bdc2dc3.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=73abbe7c015faeec8e8a3330f5160d71" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fi.gyazo.com%2F0cdb32310ccc94bc962721232bdc2dc3.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=73abbe7c015faeec8e8a3330f5160d71" alt="" data-canonical-src="https://i.gyazo.com/0cdb32310ccc94bc962721232bdc2dc3.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fi.gyazo.com%2F0cdb32310ccc94bc962721232bdc2dc3.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e585a873084ef7793cd98bf5f580de92 1x" loading="lazy"></a></p>

<h2>
<span id="継続モナドを実装する" class="fragment"></span><a href="#%E7%B6%99%E7%B6%9A%E3%83%A2%E3%83%8A%E3%83%89%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>継続モナドを実装する</h2>

<p><a href="http://www.sampou.org/haskell/a-a-monads/html/contmonad.html" rel="nofollow noopener" target="_blank">こうなってくるとわけがわからない</a></p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">class</span> <span class="nx">Cont</span> <span class="kd">extends</span> <span class="nx">Monad</span> <span class="p">{</span>
  <span class="c1">// runCont :: ((a -&gt; r) -&gt; r)</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">runCont</span><span class="p">){</span> <span class="k">super</span><span class="p">();</span> <span class="k">this</span><span class="p">.</span><span class="nx">runCont</span> <span class="o">=</span> <span class="nx">runCont</span><span class="p">;</span> <span class="p">}</span>
  <span class="c1">//  (Cont c) &gt;&gt;= f = Cont $ \k -&gt; c (\a -&gt; runCont (f a) k)</span>
  <span class="nx">bind</span><span class="p">(</span><span class="nx">f</span><span class="p">){</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Cont</span><span class="p">((</span><span class="nx">k</span><span class="p">)</span><span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">runCont</span><span class="p">((</span><span class="nx">a</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">runCont</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
  <span class="c1">// return a       = Cont $ \k -&gt; k a</span>
  <span class="kd">static</span> <span class="nx">pure</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Cont</span><span class="p">((</span><span class="nx">k</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">k</span><span class="p">(</span><span class="nx">a</span><span class="p">));</span> <span class="p">}</span>
  <span class="c1">// callCC :: ((a -&gt; m b) -&gt; m a) -&gt; m a </span>
  <span class="kd">static</span> <span class="nx">callCC</span><span class="p">(</span><span class="nx">f</span><span class="p">){</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Cont</span><span class="p">((</span><span class="nx">k</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">(</span><span class="nx">f</span><span class="p">((</span><span class="nx">a</span><span class="p">)</span><span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Cont</span><span class="p">((</span><span class="nx">_</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">k</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span> <span class="p">)).</span><span class="nx">runCont</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

<h2>
<span id="継続モナドを使ってみる" class="fragment"></span><a href="#%E7%B6%99%E7%B6%9A%E3%83%A2%E3%83%8A%E3%83%89%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>継続モナドを使ってみる</h2>

<p>緊急脱出ができる。</p>

<div class="code-frame" data-lang="js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">main</span><span class="p">(){</span>
  <span class="k">return</span> <span class="p">((</span><span class="nx">c</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">runCont</span><span class="p">((</span><span class="nx">a</span><span class="p">)</span><span class="o">=&gt;</span><span class="nx">a</span><span class="p">))(</span> <span class="nx">_do</span><span class="p">(</span><span class="nx">Cont</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
    <span class="kd">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Cont</span><span class="p">.</span><span class="nx">callCC</span><span class="p">((</span><span class="nx">exit</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">_do</span><span class="p">(</span><span class="nx">Cont</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span><span class="p">(){</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Cont</span><span class="p">.</span><span class="nx">pure</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Cont</span><span class="p">.</span><span class="nx">pure</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">a</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="mi">2</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">===</span> <span class="mi">2</span><span class="p">){</span>
        <span class="k">yield</span> <span class="nx">exit</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="c1">// escape!</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">Cont</span><span class="p">.</span><span class="nx">pure</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">);</span> <span class="c1">// never run</span>
    <span class="p">}));</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">ret</span> <span class="o">===</span> <span class="mi">100</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">Cont</span><span class="p">.</span><span class="nx">pure</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
  <span class="p">}));</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">main</span><span class="p">()</span> <span class="o">===</span> <span class="mi">100</span><span class="p">);</span>
</pre></div></div>

<p><code>exit</code> で抜けた場合と <code>return pure</code> で抜けた場合で型が同じなので例外というよりは goto のような使い方になりそう。</p>

<h2>
<span id="後記" class="fragment"></span><a href="#%E5%BE%8C%E8%A8%98"><i class="fa fa-link"></i></a>後記</h2>

<ul>
<li>xstreamモナドとかjQueryモナドとかリストモナドも書きたかった。あとで書くかも。</li>
<li>複雑になると haskell より醜い</li>
</ul>

<p>元ネタ <a href="https://qiita.com/DUxCA/items/77a36b7d2b75d8278f9d" class="autolink" id="reference-e8c18d782a2634bc0ae3">https://qiita.com/DUxCA/items/77a36b7d2b75d8278f9d</a></p>
