
<h1>
<span id="ffmpegファイル読込cvmat変換ffmpegファイル書出の雛形" class="fragment"></span><a href="#ffmpeg%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E8%AA%AD%E8%BE%BCcvmat%E5%A4%89%E6%8F%9Bffmpeg%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E6%9B%B8%E5%87%BA%E3%81%AE%E9%9B%9B%E5%BD%A2"><i class="fa fa-link"></i></a>FFmpegファイル読込→cv::Mat変換→FFmpegファイル書出の雛形</h1>

<h2>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>

<ul>
<li>OpenCV の VideoCapture, VideoWriter は avi しか扱えないなどの制限が多い</li>
<li>業を煮やしたので ffmpeg で動画を読み込んで cv::Mat に変換し、 cv::Mat から ffmpeg で書き込む方法を調べた</li>
</ul>

<h2>
<span id="ソース" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>ソース</h2>

<div class="code-frame" data-lang="c++"><div class="highlight"><pre><span class="cp">#include &lt;cstdlib&gt;
#include &lt;iostream&gt;
#include &lt;utility&gt;
#include &lt;vector&gt;
#include &lt;opencv2/opencv.hpp&gt;
#include &lt;boost/program_options.hpp&gt;
</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>

<span class="cp">#ifdef USE_FFMPEG
</span><span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
<span class="cp">#include &lt;libavformat/avformat.h&gt;
#include &lt;libavcodec/avcodec.h&gt;
#include &lt;libavutil/avutil.h&gt;
#include &lt;libavutil/pixdesc.h&gt;
#include &lt;libswscale/swscale.h&gt;
</span><span class="p">}</span>

<span class="cm">/** https://gist.github.com/yohhoy/f0444d3fc47f2bb2d0e2 */</span>
<span class="k">class</span> <span class="nc">FFmpegReader</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="kt">int</span> <span class="n">dst_width</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">dst_height</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">dst_fps</span><span class="p">;</span>
<span class="nl">private:</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">framebuf</span><span class="p">;</span>
  <span class="n">AVFrame</span><span class="o">*</span> <span class="n">decframe</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">AVFrame</span><span class="o">*</span> <span class="n">frame</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">AVStream</span><span class="o">*</span> <span class="n">vstrm</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">AVFormatContext</span><span class="o">*</span> <span class="n">inctx</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">SwsContext</span><span class="o">*</span> <span class="n">swsctx</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">vstrm_idx</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">nb_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">end_of_stream</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">got_pic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">AVPacket</span> <span class="n">pkt</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="n">FFmpegReader</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="n">filename</span><span class="p">){</span>
    <span class="n">av_register_all</span><span class="p">();</span>
    <span class="c1">// open input file context</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inctx</span><span class="p">,</span> <span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to avforamt_open_input(</span><span class="se">\"</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">filename</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\"</span><span class="s">): ret="</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// retrive input stream information</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">avformat_find_stream_info</span><span class="p">(</span><span class="n">inctx</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to avformat_find_stream_info: ret="</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// find primary video stream</span>
    <span class="n">AVCodec</span><span class="o">*</span> <span class="n">vcodec</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="n">vstrm_idx</span> <span class="o">=</span> <span class="n">av_find_best_stream</span><span class="p">(</span><span class="n">inctx</span><span class="p">,</span> <span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcodec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vstrm_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to av_find_best_stream: ret="</span> <span class="o">&lt;&lt;</span> <span class="n">vstrm_idx</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">vstrm</span> <span class="o">=</span> <span class="n">inctx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">vstrm_idx</span><span class="p">];</span>

    <span class="c1">// open video decoder context</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">avcodec_open2</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">vcodec</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to avcodec_open2: ret="</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// print input video stream informataion</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span>
      <span class="o">&lt;&lt;</span> <span class="s">"infile: "</span> <span class="o">&lt;&lt;</span> <span class="n">filename</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"format: "</span> <span class="o">&lt;&lt;</span> <span class="n">inctx</span><span class="o">-&gt;</span><span class="n">iformat</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"vcodec: "</span> <span class="o">&lt;&lt;</span> <span class="n">vcodec</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"size:   "</span> <span class="o">&lt;&lt;</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="sc">'x'</span> <span class="o">&lt;&lt;</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"fps:    "</span> <span class="o">&lt;&lt;</span> <span class="n">av_q2d</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">framerate</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">" [fps]</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"length: "</span> <span class="o">&lt;&lt;</span> <span class="n">av_rescale_q</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">duration</span><span class="p">,</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">})</span> <span class="o">/</span> <span class="mf">1000.</span> <span class="o">&lt;&lt;</span> <span class="s">" [sec]</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"pixfmt: "</span> <span class="o">&lt;&lt;</span> <span class="n">av_get_pix_fmt_name</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"frame:  "</span> <span class="o">&lt;&lt;</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">nb_frames</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">flush</span><span class="p">;</span>
    <span class="c1">// initialize sample scaler</span>
    <span class="n">dst_width</span> <span class="o">=</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
    <span class="n">dst_height</span> <span class="o">=</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
    <span class="n">dst_fps</span> <span class="o">=</span> <span class="n">av_q2d</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">framerate</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">AVPixelFormat</span> <span class="n">dst_pix_fmt</span> <span class="o">=</span> <span class="n">AV_PIX_FMT_BGR24</span><span class="p">;</span>
    <span class="n">swsctx</span> <span class="o">=</span> <span class="n">sws_getCachedContext</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">,</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">dst_height</span><span class="p">,</span> <span class="n">dst_pix_fmt</span><span class="p">,</span> <span class="n">SWS_BICUBIC</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">swsctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to sws_getCachedContext"</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"output: "</span> <span class="o">&lt;&lt;</span> <span class="n">dst_width</span> <span class="o">&lt;&lt;</span> <span class="sc">'x'</span> <span class="o">&lt;&lt;</span> <span class="n">dst_height</span> <span class="o">&lt;&lt;</span> <span class="sc">','</span> <span class="o">&lt;&lt;</span> <span class="n">av_get_pix_fmt_name</span><span class="p">(</span><span class="n">dst_pix_fmt</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="c1">// allocate frame buffer for output</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">av_frame_alloc</span><span class="p">();</span>
    <span class="n">framebuf</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">avpicture_get_size</span><span class="p">(</span><span class="n">dst_pix_fmt</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">dst_height</span><span class="p">));</span>
    <span class="n">avpicture_fill</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">AVPicture</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span> <span class="n">framebuf</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">dst_pix_fmt</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">dst_height</span><span class="p">);</span>
    <span class="c1">// decoding loop</span>
    <span class="n">decframe</span> <span class="o">=</span> <span class="n">av_frame_alloc</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">FFmpegReader</span><span class="p">(){</span>
    <span class="c1">//sws_freeContext(swsctx);</span>
    <span class="n">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decframe</span><span class="p">);</span>
    <span class="n">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
    <span class="n">avcodec_close</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
    <span class="n">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inctx</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">read</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span> <span class="n">mat</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">end_of_stream</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// read packet from input file</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">av_read_frame</span><span class="p">(</span><span class="n">inctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="n">AVERROR_EOF</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to av_read_frame: ret="</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span><span class="p">;</span>
        <span class="k">throw</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pkt</span><span class="p">.</span><span class="n">stream_index</span> <span class="o">!=</span> <span class="n">vstrm_idx</span><span class="p">){</span>
        <span class="n">av_free_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="n">mat</span><span class="p">);</span> <span class="c1">// go to next packet</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">end_of_stream</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">AVERROR_EOF</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">end_of_stream</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// null packet for bumping process</span>
      <span class="n">av_init_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
      <span class="n">pkt</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
      <span class="n">pkt</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// decode video frame</span>
    <span class="n">avcodec_decode_video2</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">decframe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got_pic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got_pic</span><span class="p">){</span>
      <span class="c1">// convert frame to OpenCV matrix</span>
      <span class="n">sws_scale</span><span class="p">(</span><span class="n">swsctx</span><span class="p">,</span> <span class="n">decframe</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">decframe</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">decframe</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">);</span>
      <span class="n">mat</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{</span><span class="n">dst_height</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">CV_8UC3</span><span class="p">,</span> <span class="n">framebuf</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">[</span><span class="mi">0</span><span class="p">]}.</span><span class="n">clone</span><span class="p">();</span>
      <span class="c1">//std::cout &lt;&lt; nb_frames &lt;&lt; '\r' &lt;&lt; std::flush;  // dump progress</span>
      <span class="o">++</span><span class="n">nb_frames</span><span class="p">;</span>
      <span class="n">av_free_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">av_free_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/** https://gist.github.com/yohhoy/52b31522dbb751e5296e */</span>
<span class="k">class</span> <span class="nc">FFmpegWriter</span> <span class="p">{</span>
<span class="nl">private:</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">imgbuf</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">framebuf</span><span class="p">;</span>
  <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">image</span><span class="p">;</span>
  <span class="n">AVFrame</span><span class="o">*</span> <span class="n">frame</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">AVFormatContext</span><span class="o">*</span> <span class="n">outctx</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">AVCodec</span><span class="o">*</span> <span class="n">vcodec</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">AVStream</span><span class="o">*</span> <span class="n">vstrm</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">SwsContext</span><span class="o">*</span> <span class="n">swsctx</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="kt">int64_t</span> <span class="n">frame_pts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">nb_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">got_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">end_of_stream</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="n">FFmpegWriter</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="n">filename</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">fps</span><span class="p">,</span> <span class="k">const</span> <span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="o">&amp;</span> <span class="n">size</span><span class="p">){</span>
    <span class="k">auto</span> <span class="n">dst_width</span> <span class="o">=</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">dst_height</span> <span class="o">=</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">dst_fps</span> <span class="o">=</span> <span class="n">AVRational</span><span class="p">{</span><span class="n">fps</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
    <span class="c1">// initialize FFmpeg library</span>
    <span class="n">av_register_all</span><span class="p">();</span>
    <span class="c1">// allocate cv::Mat with extra bytes (required by AVFrame::data)</span>
    <span class="n">imgbuf</span> <span class="o">=</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dst_height</span> <span class="o">*</span> <span class="n">dst_width</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">{</span><span class="n">dst_height</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">CV_8UC3</span><span class="p">,</span> <span class="n">imgbuf</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">dst_width</span> <span class="o">*</span> <span class="mi">3</span><span class="p">};</span>
    <span class="c1">// open output format context</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">avformat_alloc_output_context2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">outctx</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to avformat_alloc_output_context2("</span> <span class="o">&lt;&lt;</span> <span class="n">filename</span> <span class="o">&lt;&lt;</span> <span class="s">"): ret="</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// open output IO context</span>
    <span class="k">if</span><span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">avio_open2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">outctx</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">,</span> <span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">AVIO_FLAG_WRITE</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to avio_open2: ret="</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// create new video stream</span>
    <span class="n">vcodec</span> <span class="o">=</span> <span class="n">avcodec_find_encoder</span><span class="p">(</span><span class="n">outctx</span><span class="o">-&gt;</span><span class="n">oformat</span><span class="o">-&gt;</span><span class="n">video_codec</span><span class="p">);</span>
    <span class="n">vstrm</span> <span class="o">=</span> <span class="n">avformat_new_stream</span><span class="p">(</span><span class="n">outctx</span><span class="p">,</span> <span class="n">vcodec</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vstrm</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to avformat_new_stream"</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">avcodec_get_context_defaults3</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">vcodec</span><span class="p">);</span>
    <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">dst_width</span><span class="p">;</span>
    <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">dst_height</span><span class="p">;</span>
    <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">vcodec</span><span class="o">-&gt;</span><span class="n">pix_fmts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">time_base</span> <span class="o">=</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">time_base</span> <span class="o">=</span> <span class="n">av_inv_q</span><span class="p">(</span><span class="n">dst_fps</span><span class="p">);</span>
    <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">r_frame_rate</span> <span class="o">=</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">avg_frame_rate</span> <span class="o">=</span> <span class="n">dst_fps</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">outctx</span><span class="o">-&gt;</span><span class="n">oformat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AVFMT_GLOBALHEADER</span><span class="p">){</span>
      <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AV_CODEC_FLAG_GLOBAL_HEADER</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// open video encoder</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">avcodec_open2</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">vcodec</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to avcodec_open2: ret="</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span>
      <span class="o">&lt;&lt;</span> <span class="s">"outfile: "</span> <span class="o">&lt;&lt;</span> <span class="n">filename</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"format:  "</span> <span class="o">&lt;&lt;</span> <span class="n">outctx</span><span class="o">-&gt;</span><span class="n">oformat</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"vcodec:  "</span> <span class="o">&lt;&lt;</span> <span class="n">vcodec</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"size:    "</span> <span class="o">&lt;&lt;</span> <span class="n">dst_width</span> <span class="o">&lt;&lt;</span> <span class="sc">'x'</span> <span class="o">&lt;&lt;</span> <span class="n">dst_height</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"fps:     "</span> <span class="o">&lt;&lt;</span> <span class="n">av_q2d</span><span class="p">(</span><span class="n">dst_fps</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="s">"pixfmt:  "</span> <span class="o">&lt;&lt;</span> <span class="n">av_get_pix_fmt_name</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
      <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">flush</span><span class="p">;</span>
    <span class="c1">// initialize sample scaler</span>
    <span class="n">swsctx</span> <span class="o">=</span> <span class="n">sws_getCachedContext</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">dst_height</span><span class="p">,</span> <span class="n">AV_PIX_FMT_BGR24</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">dst_height</span><span class="p">,</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">,</span> <span class="n">SWS_BICUBIC</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">swsctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to sws_getCachedContext"</span><span class="p">;</span>
      <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// allocate frame buffer for encoding</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">av_frame_alloc</span><span class="p">();</span>
    <span class="n">framebuf</span> <span class="o">=</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">avpicture_get_size</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">dst_height</span><span class="p">));</span>
    <span class="n">avpicture_fill</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">AVPicture</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span> <span class="n">framebuf</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">dst_height</span><span class="p">);</span>
    <span class="n">frame</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">dst_width</span><span class="p">;</span>
    <span class="n">frame</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">dst_height</span><span class="p">;</span>
    <span class="n">frame</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">);</span>
    <span class="c1">// encoding loop</span>
    <span class="n">avformat_write_header</span><span class="p">(</span><span class="n">outctx</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">FFmpegWriter</span><span class="p">(){</span>
    <span class="c1">//sws_freeContext(swsctx);</span>
    <span class="n">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
    <span class="n">avcodec_close</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>
    <span class="n">avio_close</span><span class="p">(</span><span class="n">outctx</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">);</span>
    <span class="n">avformat_free_context</span><span class="p">(</span><span class="n">outctx</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="k">const</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span> <span class="n">mat</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end_of_stream</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">err</span> <span class="o">&lt;&lt;</span> <span class="s">"eof"</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
    <span class="c1">// retrieve source image</span>
    <span class="n">mat</span><span class="p">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
    <span class="c1">// convert cv::Mat(OpenCV) to AVFrame(FFmpeg)</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">stride</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">};</span>
    <span class="n">sws_scale</span><span class="p">(</span><span class="n">swsctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">image</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">);</span>
    <span class="n">frame</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">=</span> <span class="n">frame_pts</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">encode</span><span class="p">()){</span>
      <span class="n">end_of_stream</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">end</span><span class="p">(){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"end_of_stream"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">end_of_stream</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"encode"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">encode</span><span class="p">()){</span> <span class="s">"noop"</span><span class="p">;</span> <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"av_write_trailer"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">av_write_trailer</span><span class="p">(</span><span class="n">outctx</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">nb_frames</span> <span class="o">&lt;&lt;</span> <span class="s">" frames encoded"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nl">private:</span>
  <span class="kt">bool</span> <span class="n">encode</span><span class="p">(){</span>
    <span class="c1">// encode video frame</span>
    <span class="n">AVPacket</span> <span class="n">pkt</span><span class="p">;</span>
    <span class="n">pkt</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="n">pkt</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">av_init_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">avcodec_encode_video2</span><span class="p">(</span><span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="n">end_of_stream</span> <span class="o">?</span> <span class="nb">nullptr</span> <span class="o">:</span> <span class="n">frame</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">got_pkt</span><span class="p">);</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"fail to avcodec_encode_video2: ret="</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
      <span class="n">av_free_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got_pkt</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// rescale packet timestamp</span>
      <span class="n">pkt</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">av_packet_rescale_ts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">,</span> <span class="n">vstrm</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">);</span>
      <span class="c1">// write packet</span>
      <span class="n">av_write_frame</span><span class="p">(</span><span class="n">outctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
      <span class="c1">//std::cout &lt;&lt; nb_frames &lt;&lt; '\r' &lt;&lt; std::flush;  // dump progress</span>
      <span class="o">++</span><span class="n">nb_frames</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">av_free_packet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">got_pkt</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif
</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
  <span class="n">string</span> <span class="n">INPUT_VIDEO_PATH</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">OUTPUT_VIDEO_PATH</span><span class="p">;</span>
  <span class="k">namespace</span> <span class="n">po</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">program_options</span><span class="p">;</span>
  <span class="n">po</span><span class="o">::</span><span class="n">options_description</span> <span class="n">opt</span><span class="p">(</span><span class="s">"option"</span><span class="p">);</span>
  <span class="n">opt</span><span class="p">.</span><span class="n">add_options</span><span class="p">()</span>
    <span class="p">(</span><span class="s">"help,h"</span><span class="p">,</span> <span class="s">"show this menu"</span><span class="p">)</span>
    <span class="p">(</span><span class="s">"input,i"</span><span class="p">,</span> <span class="n">po</span><span class="o">::</span><span class="n">value</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">INPUT_VIDEO_PATH</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">required</span><span class="p">(),</span> <span class="s">"input video file path"</span><span class="p">)</span>
    <span class="p">(</span><span class="s">"output,o"</span><span class="p">,</span> <span class="n">po</span><span class="o">::</span><span class="n">value</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OUTPUT_VIDEO_PATH</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">required</span><span class="p">(),</span> <span class="s">"output mp4 video file path"</span><span class="p">)</span>
  <span class="p">;</span>
  <span class="k">auto</span> <span class="n">vm</span> <span class="o">=</span> <span class="n">po</span><span class="o">::</span><span class="n">variables_map</span><span class="p">{};</span>
  <span class="k">try</span><span class="p">{</span>
    <span class="n">po</span><span class="o">::</span><span class="n">store</span><span class="p">(</span><span class="n">po</span><span class="o">::</span><span class="n">parse_command_line</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">opt</span><span class="p">),</span> <span class="n">vm</span><span class="p">);</span>
    <span class="n">po</span><span class="o">::</span><span class="n">notify</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Error: "</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Using OpenCV version "</span> <span class="o">&lt;&lt;</span> <span class="n">CV_VERSION</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">cv</span><span class="o">::</span><span class="n">getBuildInformation</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">opt</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// put help</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">vm</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="s">"help"</span><span class="p">)</span>  <span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Using OpenCV version "</span> <span class="o">&lt;&lt;</span> <span class="n">CV_VERSION</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">cv</span><span class="o">::</span><span class="n">getBuildInformation</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">opt</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// put help</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>

<span class="cp">#ifdef USE_FFMPEG
</span>  <span class="k">auto</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">FFmpegReader</span><span class="p">(</span><span class="n">INPUT_VIDEO_PATH</span><span class="p">};</span>
  <span class="k">auto</span> <span class="n">fps</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">dst_fps</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">DEST_SIZE</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">{</span><span class="n">reader</span><span class="p">.</span><span class="n">dst_width</span><span class="p">,</span> <span class="n">reader</span><span class="p">.</span><span class="n">dst_height</span><span class="p">};</span>
  <span class="k">auto</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">FFmpegWriter</span><span class="p">{</span><span class="n">OUTPUT_VIDEO_PATH</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fps</span><span class="p">),</span> <span class="n">DEST_SIZE</span><span class="p">};</span>
<span class="cp">#else
</span>  <span class="k">auto</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoCapture</span><span class="p">{</span><span class="n">INPUT_VIDEO_PATH</span><span class="p">};</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">reader</span><span class="p">.</span><span class="n">isOpened</span><span class="p">()){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"C++: reader cannot opened</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">throw</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_WIDTH</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_HEIGHT</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">fps</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FPS</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">DEST_SIZE</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">{</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">};</span>
  <span class="k">auto</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">VideoWriter</span><span class="p">(</span><span class="s">"appsrc ! videoconvert ! x264enc ! video/x-h264,profile=main ! mp4mux ! filesink location="</span> <span class="o">+</span> <span class="n">OUTPUT_VIDEO_PATH</span> <span class="o">+</span> <span class="s">"  "</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">DEST_SIZE</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">writer</span><span class="p">.</span><span class="n">isOpened</span><span class="p">()){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"C++: writer not opened</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">throw</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif
</span>  <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">mat</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">mat</span><span class="p">)){</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">mat</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#ifdef USE_FFMPEG
</span>  <span class="n">writer</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<span class="cp">#endif
</span>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"finished"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="err">}</span>
</pre></div></div>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<ul>
<li><a href="https://qiita.com/yohhoy/items/d3b05152dac1dd533131" id="reference-a003faea01d6b593514f">FFmpegファイル読込＋OpenCV画像処理の雛形</a></li>
<li><a href="https://qiita.com/yohhoy/items/50c6771168a91e8d0367" id="reference-8fcb42ce8b3e3072095d">OpenCV画像処理＋FFmpegファイル書出の雛形</a></li>
<li><a href="https://ffmpeg.org/documentation.html" class="autolink" rel="nofollow noopener" target="_blank">https://ffmpeg.org/documentation.html</a></li>
<li><a href="https://docs.opencv.org/3.3.0/d8/dfe/classcv_1_1VideoCapture.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.opencv.org/3.3.0/d8/dfe/classcv_1_1VideoCapture.html</a></li>
<li><a href="https://docs.opencv.org/2.4.11/modules/highgui/doc/reading_and_writing_images_and_video.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.opencv.org/2.4.11/modules/highgui/doc/reading_and_writing_images_and_video.html</a></li>
</ul>
